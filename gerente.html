<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel del Gerente - Blue Elegance</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    :root {
      --primary: #1e40af;
      --primary-dark: #1e3a8a;
      --primary-light: #3b82f6;
      --accent: #06b6d4;
      --dark: #0f172a;
      --dark-light: #1e293b;
      --text: #f8fafc;
      --text-secondary: #cbd5e1;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --gold: #d4af37;
    }

    body {
      background: linear-gradient(135deg, var(--dark) 0%, #0a0f2b 50%, var(--dark) 100%);
      color: var(--text);
      line-height: 1.6;
      padding: 20px;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .container {
      max-width: 1400px;
      margin: auto;
      background: rgba(15, 23, 42, 0.9);
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 15px 40px rgba(0, 0, 0, 0.5);
      animation: slideUp 0.8s ease-out;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(30, 64, 175, 0.3);
    }

    @keyframes slideUp {
      from { transform: translateY(30px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 35px;
      padding: 25px;
      border-radius: 16px;
      background: linear-gradient(145deg, var(--dark-light), var(--dark));
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(30, 64, 175, 0.2);
    }

    header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--accent), var(--primary-light));
    }

    .logo-container {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .logo-img-container {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: linear-gradient(145deg, var(--dark-light), var(--dark));
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
      overflow: hidden;
      border: 3px solid var(--primary);
      position: relative;
    }

    .logo-img-container::after {
      content: '';
      position: absolute;
      top: -2px;
      left: -2px;
      right: -2px;
      bottom: -2px;
      background: linear-gradient(45deg, var(--primary), var(--accent), var(--primary-light));
      border-radius: 50%;
      z-index: -1;
      animation: rotate 3s linear infinite;
    }

    @keyframes rotate {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .logo-img-container img {
      max-width: 75%;
      max-height: 75%;
      object-fit: contain;
      border-radius: 50%;
    }

    .logo-text h1 {
      color: var(--text);
      font-size: 2.2rem;
      margin-bottom: 5px;
      font-weight: 700;
      background: linear-gradient(90deg, var(--primary-light), var(--accent));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .logo-text p {
      color: var(--text-secondary);
      font-size: 1.1rem;
      font-weight: 500;
      letter-spacing: 0.5px;
    }

    .header-controls {
      display: flex;
      gap: 12px;
    }

    h2 {
      color: var(--text);
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid var(--primary);
      font-size: 1.8rem;
      display: flex;
      align-items: center;
      gap: 12px;
      position: relative;
    }

    h2::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      width: 80px;
      height: 3px;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      border-radius: 3px;
    }

    /* Resumen general mejorado */
    .resumen-general {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 35px;
    }

    .resumen-item {
      background: linear-gradient(145deg, var(--dark-light), var(--dark));
      padding: 25px;
      border-radius: 16px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
      text-align: center;
      transition: all 0.4s ease;
      border-left: 4px solid var(--primary);
      position: relative;
      overflow: hidden;
    }

    .resumen-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, rgba(30, 64, 175, 0.1), rgba(6, 182, 212, 0.1));
      opacity: 0;
      transition: opacity 0.4s ease;
    }

    .resumen-item:hover {
      transform: translateY(-8px) scale(1.02);
      box-shadow: 0 15px 30px rgba(0, 0, 0, 0.5);
    }

    .resumen-item:hover::before {
      opacity: 1;
    }

    .resumen-item .icono {
      font-size: 2.5rem;
      margin-bottom: 15px;
      color: var(--primary-light);
      transition: transform 0.3s ease;
    }

    .resumen-item:hover .icono {
      transform: scale(1.2);
      color: var(--accent);
    }

    .resumen-item .valor {
      font-size: 2.2rem;
      font-weight: bold;
      color: var(--text);
      margin-bottom: 8px;
      transition: color 0.3s ease;
    }

    .resumen-item:hover .valor {
      color: var(--accent);
    }

    .resumen-item .etiqueta {
      font-size: 1rem;
      color: var(--text-secondary);
      font-weight: 600;
      letter-spacing: 0.5px;
    }

    /* NUEVOS ESTILOS PARA LAS MEJORAS */
    
    /* Indicador de eficiencia */
    .eficiencia-indicator {
      margin-top: 10px;
      padding: 8px;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 600;
      text-align: center;
      background: rgba(30, 64, 175, 0.2);
      border-left: 3px solid var(--primary);
    }
    
    .eficiencia-baja {
      background: rgba(239, 68, 68, 0.2);
      border-left-color: var(--danger);
      color: var(--danger);
    }
    
    .eficiencia-media {
      background: rgba(245, 158, 11, 0.2);
      border-left-color: var(--warning);
      color: var(--warning);
    }
    
    .eficiencia-alta {
      background: rgba(16, 185, 129, 0.2);
      border-left-color: var(--success);
      color: var(--success);
    }
    
    .eficiencia-excelente {
      background: rgba(212, 175, 55, 0.3) !important;
      border-left: 3px solid var(--gold) !important;
      color: var(--gold) !important;
      font-weight: bold;
    }
    
    /* Secci√≥n de citas agregadas hoy */
    .citas-agregadas-hoy {
      background: linear-gradient(145deg, var(--dark-light), var(--dark));
      padding: 25px;
      border-radius: 16px;
      margin: 25px 0;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(30, 64, 175, 0.3);
      position: relative;
      overflow: hidden;
    }
    
    .citas-agregadas-hoy::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--accent), var(--primary-light));
    }
    
    .citas-agregadas-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .cita-agregada-item {
      background: rgba(30, 41, 59, 0.7);
      padding: 20px;
      border-radius: 12px;
      border-left: 4px solid var(--primary);
      transition: all 0.3s ease;
    }
    
    .cita-agregada-item:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
    }
    
    .cita-agregada-supervisora {
      font-weight: 600;
      color: var(--text);
      margin-bottom: 10px;
      font-size: 1.1rem;
    }
    
    .cita-agregada-cantidad {
      font-size: 1.8rem;
      font-weight: bold;
      color: var(--accent);
      margin-bottom: 8px;
    }
    
    .cita-agregada-eficiencia {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    /* Panel del Gerente mejorado */
    .gerente-panel {
      background: linear-gradient(145deg, var(--dark-light), var(--dark));
      padding: 30px;
      border-radius: 16px;
      margin-top: 30px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(30, 64, 175, 0.2);
    }

    .gerente-panel::before {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 200px;
      height: 200px;
      background: radial-gradient(circle, rgba(30, 64, 175, 0.1) 0%, rgba(30, 64, 175, 0) 70%);
      border-radius: 50%;
    }

    .gerente-panel h2 {
      color: var(--text);
      margin-bottom: 25px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .stats-container {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 35px;
    }

    .stat-card {
      flex: 1;
      min-width: 240px;
      background: linear-gradient(145deg, var(--dark-light), var(--dark));
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
      text-align: center;
      transition: all 0.4s ease;
      border-top: 4px solid var(--primary);
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      transform: scaleX(0);
      transform-origin: left;
      transition: transform 0.4s ease;
    }

    .stat-card:hover::before {
      transform: scaleX(1);
    }

    .stat-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 12px 25px rgba(0, 0, 0, 0.5);
    }

    .stat-card.leader {
      background: linear-gradient(145deg, var(--gold), #b8941f);
      color: #1a1a1a;
      border-top: 4px solid #f4d03f;
    }

    .stat-card.leader .count {
      color: #1a1a1a !important;
    }

    .stat-card h3 {
      font-size: 1.2rem;
      margin-bottom: 18px;
      color: inherit;
      font-weight: 600;
    }

    .stat-card .count {
      font-size: 2.5rem;
      font-weight: bold;
      margin-bottom: 12px;
      transition: transform 0.3s ease;
      color: var(--text);
    }

    .stat-card:hover .count {
      transform: scale(1.1);
      color: var(--accent);
    }

    .stat-card .supervisora {
      font-size: 0.95rem;
      opacity: 0.9;
      color: var(--text-secondary);
    }

    /* Estilo para mostrar el conteo por d√≠a */
    .conteo-dia {
      margin-top: 15px;
      padding: 12px;
      background: rgba(30, 41, 59, 0.7);
      border-radius: 8px;
      font-size: 0.9rem;
      border-left: 3px solid var(--primary);
    }

    .conteo-dia .titulo {
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 5px;
    }

    .conteo-dia .valor-dia {
      font-size: 1.3rem;
      font-weight: bold;
      color: var(--text);
    }

    .supervisora-detalle {
      margin-top: 35px;
    }

    .supervisora-detalle h3 {
      margin-bottom: 20px;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1.4rem;
    }

    .supervisora-citas {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }

    .cita-item {
      background: linear-gradient(145deg, var(--dark-light), var(--dark));
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 5px 12px rgba(0, 0, 0, 0.3);
      border-left: 4px solid var(--primary);
      font-size: 0.95rem;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .cita-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: linear-gradient(to bottom, var(--primary), var(--accent));
      transition: width 0.3s ease;
    }

    .cita-item:hover {
      transform: translateX(8px);
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.4);
    }

    .cita-item:hover::before {
      width: 6px;
    }

    .cita-item .cita-numero {
      font-weight: bold;
      color: var(--accent);
      font-size: 1.1rem;
    }

    .cita-item .cita-cliente {
      margin: 10px 0;
      font-weight: 500;
      color: var(--text);
    }

    .cita-item .cita-hora {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    /* Controles para el panel del gerente mejorados */
    .panel-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 30px;
      align-items: center;
      padding: 25px;
      background: rgba(30, 41, 59, 0.7);
      border-radius: 12px;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(5px);
      border: 1px solid rgba(30, 64, 175, 0.2);
    }

    .filtro-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
      padding: 18px;
      background: rgba(30, 41, 59, 0.8);
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      transition: all 0.3s ease;
      min-width: 240px;
      border: 1px solid #334155;
      position: relative;
      overflow: hidden;
    }

    .filtro-group::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      transform: scaleX(0);
      transform-origin: left;
      transition: transform 0.3s ease;
    }

    .filtro-group:hover::before {
      transform: scaleX(1);
    }

    .filtro-group:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.4);
      background: rgba(30, 41, 59, 0.9);
    }

    .filtro-group label {
      margin: 0;
      font-size: 0.95rem;
      color: var(--text);
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .filtro-group input, .filtro-group select {
      margin: 0;
      padding: 12px;
      border: 1px solid #475569;
      border-radius: 8px;
      background: var(--dark-light);
      color: var(--text);
      font-size: 0.95rem;
      transition: all 0.3s ease;
    }

    .filtro-group input:focus, .filtro-group select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.2);
      outline: none;
    }

    .btn-group {
      display: flex;
      gap: 15px;
      align-items: center;
      flex-wrap: wrap;
    }

    .btn-filtro {
      background: linear-gradient(145deg, var(--primary), var(--primary-dark));
      color: var(--text);
      border: none;
      padding: 14px 22px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 5px 12px rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      gap: 10px;
      position: relative;
      overflow: hidden;
    }

    .btn-filtro::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s ease;
    }

    .btn-filtro:hover::before {
      left: 100%;
    }

    .btn-filtro:hover {
      background: linear-gradient(145deg, var(--primary-light), var(--primary));
      transform: translateY(-3px);
      box-shadow: 0 8px 18px rgba(0, 0, 0, 0.4);
    }

    .btn-filtro:active {
      transform: translateY(0);
    }

    .btn-filtro i {
      font-size: 1.1rem;
    }

    .btn-limpiar {
      background: linear-gradient(145deg, var(--danger), #dc2626);
    }

    .btn-limpiar:hover {
      background: linear-gradient(145deg, #dc2626, #b91c1c);
    }

    .btn-exportar {
      background: linear-gradient(145deg, var(--success), #059669);
    }

    .btn-exportar:hover {
      background: linear-gradient(145deg, #059669, #047857);
    }

    .btn-volver {
      background: linear-gradient(145deg, #8b5cf6, #7c3aed);
    }

    .btn-volver:hover {
      background: linear-gradient(145deg, #7c3aed, #6d28d9);
    }

    .btn-citas-mes {
      background: linear-gradient(145deg, var(--gold), #b8941f);
    }

    .btn-citas-mes:hover {
      background: linear-gradient(145deg, #b8941f, var(--gold));
    }

    .sin-datos {
      text-align: center;
      padding: 50px;
      color: var(--text-secondary);
      font-style: italic;
      font-size: 1.2rem;
      background: rgba(30, 41, 59, 0.7);
      border-radius: 12px;
      box-shadow: 0 5px 12px rgba(0, 0, 0, 0.3);
    }

    .notificacion {
      position: fixed;
      top: 25px;
      right: 25px;
      background: linear-gradient(145deg, var(--success), #059669);
      color: var(--text);
      padding: 18px 25px;
      border-radius: 10px;
      z-index: 1000;
      box-shadow: 0 8px 20px rgba(0,0,0,0.4);
      animation: slideInRight 0.5s ease-out;
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 500;
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .notificacion.error {
      background: linear-gradient(145deg, var(--danger), #dc2626);
    }

    @keyframes slideInRight {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .actualizando {
      display: inline-block;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Gr√°fico mejorado */
    .grafico-container {
      background: linear-gradient(145deg, var(--dark-light), var(--dark));
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
      margin-bottom: 30px;
      position: relative;
      overflow: hidden;
      border: 1px solid rgba(30, 64, 175, 0.2);
    }

    .grafico-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--accent), var(--primary-light));
    }

    .barra {
      display: flex;
      align-items: center;
      margin-bottom: 18px;
      position: relative;
    }

    .barra-label {
      width: 160px;
      font-weight: 600;
      color: var(--text);
    }

    .barra-progreso {
      flex: 1;
      height: 28px;
      background: #334155;
      border-radius: 14px;
      overflow: hidden;
      position: relative;
      box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.3);
    }

    .barra-relleno {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--accent));
      border-radius: 14px;
      transition: width 1.2s ease;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 12px;
      color: var(--text);
      font-weight: 600;
      font-size: 0.85rem;
      position: relative;
      overflow: hidden;
    }

    .barra-relleno::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transform: translateX(-100%);
      animation: shine 2s infinite;
    }

    @keyframes shine {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    /* Estado de carga */
    .cargando {
      text-align: center;
      padding: 40px;
      color: var(--text-secondary);
    }

    .cargando i {
      font-size: 2rem;
      margin-bottom: 15px;
      animation: spin 1.5s linear infinite;
    }

    /* Estilos para la lista de supervisoras sin duplicados */
    .supervisoras-lista-unica {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 15px;
    }
    
    .supervisora-unica-item {
      background: rgba(30, 64, 175, 0.2);
      padding: 8px 15px;
      border-radius: 20px;
      font-size: 0.9rem;
      color: var(--primary-light);
      border: 1px solid rgba(30, 64, 175, 0.5);
    }

    /* Estilos para el modal de citas del mes */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.8);
      animation: fadeIn 0.3s;
      overflow-y: auto;
    }

    .modal-contenido {
      background: linear-gradient(145deg, var(--dark-light), var(--dark));
      margin: 2% auto;
      padding: 30px;
      border-radius: 16px;
      width: 95%;
      max-width: 1400px;
      box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
      animation: slideDown 0.3s;
      border: 1px solid rgba(30, 64, 175, 0.3);
      position: relative;
      overflow: hidden;
    }

    .modal-contenido::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--gold), #f4d03f, var(--gold));
    }

    @keyframes slideDown {
      from { transform: translateY(-50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(212, 175, 55, 0.3);
    }

    .modal-header h3 {
      color: var(--gold);
      font-size: 1.8rem;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .cerrar-modal {
      color: var(--gold);
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .cerrar-modal:hover {
      color: #f4d03f;
      transform: rotate(90deg);
    }

    /* Pesta√±as para las citas del mes */
    .pestanas-mes {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 25px;
      padding: 15px;
      background: rgba(30, 41, 59, 0.7);
      border-radius: 12px;
      border: 1px solid rgba(212, 175, 55, 0.2);
    }

    .pestana-dia {
      background: linear-gradient(145deg, var(--dark-light), var(--dark));
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      border: 1px solid rgba(212, 175, 55, 0.3);
      color: var(--text);
      position: relative;
      overflow: hidden;
    }

    .pestana-dia::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background: linear-gradient(90deg, var(--gold), #f4d03f);
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }

    .pestana-dia.activa {
      background: linear-gradient(145deg, rgba(212, 175, 55, 0.2), rgba(244, 208, 63, 0.1));
      border-color: var(--gold);
      color: var(--gold);
    }

    .pestana-dia.activa::before {
      transform: scaleX(1);
    }

    .pestana-dia:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(212, 175, 55, 0.3);
    }

    .contenido-pestana {
      display: none;
    }

    .contenido-pestana.activa {
      display: block;
    }

    .resumen-citas-mes {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .resumen-mes-item {
      background: linear-gradient(145deg, var(--dark-light), var(--dark));
      padding: 25px;
      border-radius: 12px;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
      text-align: center;
      border-left: 4px solid var(--gold);
    }

    .resumen-mes-item .titulo {
      font-size: 1.1rem;
      color: var(--text-secondary);
      margin-bottom: 10px;
    }

    .resumen-mes-item .valor {
      font-size: 2.2rem;
      font-weight: bold;
      color: var(--gold);
      margin-bottom: 8px;
    }

    .resumen-mes-item .detalle {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .container {
        max-width: 95%;
        padding: 25px;
      }
      
      .resumen-general {
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }
    }

    @media (max-width: 992px) {
      .container {
        padding: 20px;
      }
      
      header {
        flex-direction: column;
        gap: 25px;
        text-align: center;
      }
      
      .logo-text h1 {
        font-size: 2.2rem;
      }
      
      .header-controls {
        justify-content: center;
        flex-wrap: wrap;
        width: 100%;
      }
      
      .stats-container {
        flex-direction: column;
      }
      
      .supervisora-citas {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      }
      
      .panel-controls {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .filtro-group {
        min-width: 100%;
      }
      
      .btn-group {
        width: 100%;
        justify-content: center;
      }
    }

    @media (max-width: 768px) {
      body {
        padding: 15px;
      }
      
      .container {
        padding: 15px;
        border-radius: 15px;
      }
      
      header {
        padding: 20px;
      }
      
      .logo-container {
        flex-direction: column;
        gap: 15px;
      }
      
      .logo-text h1 {
        font-size: 2rem;
      }
      
      .logo-text p {
        font-size: 1.1rem;
      }
      
      .resumen-general {
        grid-template-columns: 1fr;
        gap: 20px;
      }
      
      .gerente-panel {
        padding: 20px;
      }
      
      .supervisora-citas {
        grid-template-columns: 1fr;
      }
      
      .panel-controls {
        padding: 20px;
      }
      
      h2 {
        font-size: 1.7rem;
      }
      
      .notificacion {
        top: 15px;
        right: 15px;
        left: 15px;
        text-align: center;
        justify-content: center;
      }
      
      .pestanas-mes {
        flex-direction: column;
      }
      
      .pestana-dia {
        text-align: center;
      }
    }

    @media (max-width: 576px) {
      body {
        padding: 10px;
      }
      
      .container {
        padding: 15px;
      }
      
      .logo-img-container {
        width: 80px;
        height: 80px;
      }
      
      .logo-text h1 {
        font-size: 1.8rem;
      }
      
      .resumen-item {
        padding: 20px;
      }
      
      .resumen-item .valor {
        font-size: 2.2rem;
      }
    }

/* Q & NQ*/

@media (max-width: 576px) {
  body {
    padding: 10px;
  }
  
  .container {
    padding: 15px;
  }
  
  .logo-img-container {
    width: 80px;
    height: 80px;
  }
  
  .logo-text h1 {
    font-size: 1.8rem;
  }
  
  .resumen-item {
    padding: 20px;
  }
  
  .resumen-item .valor {
    font-size: 2.2rem;
  }
}

/* ESTILOS PARA Q & NQ - AGREGAR AL FINAL DEL CSS */
.qnq-card:hover {
  transform: translateY(-8px) !important;
  box-shadow: 0 15px 30px rgba(0, 0, 0, 0.4) !important;
}

.supervisora-qnq {
  transition: all 0.3s ease;
}

.supervisora-qnq:hover {
  transform: translateX(5px);
  background: rgba(30, 64, 175, 0.3) !important;
}
  </style>
</head>
<body>
  <!-- Modal para citas del mes -->
  <div id="modalCitasMes" class="modal">
    <div class="modal-contenido">
      <div class="modal-header">
        <h3><i class="fas fa-calendar-alt"></i> CITAS DEL MES</h3>
        <span class="cerrar-modal">&times;</span>
      </div>
      <div id="contenidoCitasMes">
        <!-- El contenido se cargar√° din√°micamente -->
      </div>
    </div>
  </div>

  <div class="container">
    <header>
      <div class="logo-container">
        <div class="logo-img-container">
          <img src="Imagenes/logo.png" alt="Logo Blue Elegance">
        </div>
        <div class="logo-text">
          <h1>BLUE ELEGANCE</h1>
          <p>PANEL DE CONTROL - GERENTE</p>
        </div>
      </div>
      <div class="header-controls">
        <button class="btn-filtro" id="actualizarBtn">
          <i class="fas fa-sync-alt"></i> ACTUALIZAR
        </button>
        <button class="btn-filtro btn-citas-mes" id="btnCitasMes">
          <i class="fas fa-calendar-alt"></i> VER CITAS DEL MES
        </button>
        <button class="btn-filtro btn-exportar" id="exportarEstadisticas">
          <i class="fas fa-file-excel"></i> EXPORTAR ESTAD√çSTICAS
        </button>
        <button class="btn-filtro btn-volver" onclick="window.location.href='index.html'">
          <i class="fas fa-arrow-left"></i> VOLVER AL SISTEMA
        </button>
      </div>
    </header>

    <!-- Resumen General -->
    <section class="resumen-general" id="resumenGeneral">
      <div class="cargando">
        <i class="fas fa-spinner"></i>
        <p>CARGANDO DATOS...</p>
      </div>
    </section>

    <!-- NUEVA SECCI√ìN: Citas Agregadas Hoy -->
    <section class="citas-agregadas-hoy" id="citasAgregadasHoy">
      <h2><i class="fas fa-calendar-plus"></i> CITAS AGREGADAS HOY</h2>
      <div class="citas-agregadas-grid" id="citasAgregadasGrid">
        <div class="cargando">
          <i class="fas fa-spinner"></i>
          <p>CARGANDO CITAS DE HOY...</p>
        </div>
      </div>
    </section>

    <!-- Gr√°fico de distribuci√≥n -->
    <div class="grafico-container">
      <h2><i class="fas fa-chart-bar"></i> DISTRIBUCI√ìN DE CITAS POR SUPERVISORA</h2>
      <div id="graficoBarras">
        <div class="cargando">
          <i class="fas fa-spinner"></i>
          <p>CARGANDO GR√ÅFICO...</p>
        </div>
      </div>
    </div>

    <!-- Panel del Gerente -->
    <section class="gerente-panel">
      <h2><i class="fas fa-chart-line"></i> ESTAD√çSTICAS POR SUPERVISORA</h2>
      
      <!-- Controles para el panel del gerente -->
      <div class="panel-controls">
        <div class="filtro-group">
          <label for="filtroFecha"><i class="fas fa-calendar-alt"></i> FILTRAR POR FECHA:</label>
          <input type="date" id="filtroFecha">
        </div>
        
        <div class="filtro-group">
          <label for="filtroSupervisora"><i class="fas fa-user-tie"></i> FILTRAR POR SUPERVISORA:</label>
          <select id="filtroSupervisora">
            <option value="">CARGANDO SUPERVISORAS...</option>
          </select>
        </div>
        
        <!-- NUEVOS CONTROLES PARA RANGO DE FECHAS -->
        <div class="filtro-group">
          <label for="fechaInicio"><i class="fas fa-calendar-day"></i> FECHA INICIO:</label>
          <input type="date" id="fechaInicio">
        </div>

        <div class="filtro-group">
          <label for="fechaFin"><i class="fas fa-calendar-day"></i> FECHA FIN:</label>
          <input type="date" id="fechaFin">
        </div>
        
        <div class="btn-group">
          <button type="button" id="aplicarFiltro" class="btn-filtro">
            <i class="fas fa-filter"></i> APLICAR FILTROS
          </button>
          <button type="button" id="limpiarFiltro" class="btn-filtro btn-limpiar">
            <i class="fas fa-broom"></i> LIMPIAR
          </button>
          <button type="button" id="btnBuscarPorFechas" class="btn-filtro">
            <i class="fas fa-search"></i> BUSCAR POR FECHAS
          </button>
          <button type="button" id="btnDescargarMes" class="btn-filtro btn-exportar">
            <i class="fas fa-file-download"></i> DESCARGAR PREMANIFIESTO MES
          </button>
        </div>
      </div>
      
      <div class="stats-container" id="statsContainer">
        <div class="cargando">
          <i class="fas fa-spinner"></i>
          <p>CARGANDO ESTAD√çSTICAS...</p>
        </div>
      </div>
      
      <div class="supervisora-detalle" id="supervisoraDetalle">
        <div class="cargando">
          <i class="fas fa-spinner"></i>
          <p>CARGANDO DETALLES DE CITAS...</p>
        </div>
      </div>
    </section>
  </div>

  <!-- Librer√≠as necesarias -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- ExcelJS para estilos en Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
  <!-- FileSaver para guardar archivos -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <script>
    // Configuraci√≥n de Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyASUJrQNMW80DDMV8gFzjTYPUd8x3B5YDk",
      authDomain: "invitacionpremanfiesto.firebaseapp.com",
      databaseURL: "https://invitacionpremanfiesto-default-rtdb.firebaseio.com",
      projectId: "invitacionpremanfiesto",
      storageBucket: "invitacionpremanfiesto.firebasestorage.app",
      messagingSenderId: "362764197269",
      appId: "1:362764197269:web:058b028dcc53d299df6a9c",
      measurementId: "G-JYTW87S1MP"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);

    // Variables globales
    let listaSupervisoras = [];
    let registrosPremanifiesto = [];

    document.addEventListener("DOMContentLoaded", function () {
      // --- FUNCIONES PRINCIPALES ---

      // FUNCI√ìN MEJORADA: Convertir datos de Firebase a array
      function convertirDatosFirebase(snapshotData) {
        console.log("üìä DATOS RECIBIDOS DE FIREBASE:", snapshotData);
        
        if (!snapshotData) {
          console.log("‚ùå NO HAY DATOS EN FIREBASE");
          return [];
        }
        
        if (Array.isArray(snapshotData)) {
          console.log("‚úÖ LOS DATOS YA SON UN ARRAY");
          return snapshotData.filter(item => item !== null && item !== undefined);
        }
        
        if (typeof snapshotData === 'object') {
          console.log("üîÑ CONVIRTIENDO OBJETO A ARRAY...");
          const arrayResultado = Object.values(snapshotData).filter(item => item !== null && item !== undefined);
          console.log("‚úÖ CONVERSI√ìN EXITOSA:", arrayResultado.length, "REGISTROS");
          return arrayResultado;
        }
        
        console.log("‚ùå FORMATO DE DATOS NO RECONOCIDO");
        return [];
      }

      // FUNCI√ìN MEJORADA: Configurar Firebase EN TIEMPO REAL
      function configurarFirebase() {
        const database = firebase.database();
        const registrosRef = database.ref('registrosPremanifiesto');
        
        console.log("üîÑ CONECTANDO A FIREBASE DESDE EL PANEL DEL GERENTE...");
        
        // Escuchar cambios en tiempo real desde Firebase
        registrosRef.on('value', (snapshot) => {
          const data = snapshot.val();
          console.log("üìä DATOS CRUDOS DE FIREBASE (ACTUALIZACI√ìN AUTOM√ÅTICA):", data);
          
          if (!data) {
            console.log("‚ùå NO HAY DATOS EN FIREBASE");
            registrosPremanifiesto = [];
            mostrarNotificacion("NO HAY DATOS EN LA BASE DE DATOS", 'error');
            return;
          }
          
          registrosPremanifiesto = convertirDatosFirebase(data);
          
          console.log("‚úÖ DATOS PROCESADOS:", registrosPremanifiesto.length, "REGISTROS EN TIEMPO REAL");
          
          if (registrosPremanifiesto.length > 0) {
            console.log("üìù PRIMER REGISTRO:", registrosPremanifiesto[0]);
            console.log("üìù √öLTIMO REGISTRO:", registrosPremanifiesto[registrosPremanifiesto.length - 1]);
          }
          
          // Actualizar TODAS las secciones del panel autom√°ticamente
          actualizarTodoElPanel();
          mostrarNotificacion("‚úÖ DATOS ACTUALIZADOS EN TIEMPO REAL - " + registrosPremanifiesto.length + " CITAS");
          
        }, (error) => {
          console.error("üî• ERROR DE FIREBASE:", error);
          mostrarNotificacion("ERROR AL CONECTAR CON FIREBASE: " + error.message, 'error');
        });
        
        // Configurar listener para supervisoras en tiempo real
        configurarListenerSupervisoras();
      }

      function configurarListenerSupervisoras() {
        const database = firebase.database();
        
        database.ref('supervisoras').on('value', (snapshot) => {
          const data = snapshot.val();
          console.log("üë• DATOS DE SUPERVISORAS (ACTUALIZACI√ìN AUTOM√ÅTICA):", data);
          
          if (data) {
            // Manejar diferentes formatos de datos
            if (Array.isArray(data)) {
              listaSupervisoras = [...new Set(data.filter(s => s && s.trim() !== ''))];
            } else if (typeof data === 'object') {
              listaSupervisoras = [...new Set(Object.values(data).filter(s => s && s.trim() !== ''))];
            } else {
              listaSupervisoras = [];
            }
            
            cargarListaSupervisoras();
            console.log("‚úÖ SUPERVISORAS ACTUALIZADAS:", listaSupervisoras);
            
            if (registrosPremanifiesto.length > 0) {
              actualizarTodoElPanel();
            }
          } else {
            console.log("‚ùå NO HAY DATOS DE SUPERVISORAS");
            listaSupervisoras = [];
            cargarListaSupervisoras();
          }
        }, (error) => {
          console.error("üî• ERROR AL CARGAR SUPERVISORAS:", error);
          mostrarNotificacion("ERROR AL CARGAR LISTA DE SUPERVISORAS", 'error');
        });
      }

      // NUEVA FUNCI√ìN: Actualizar todo el panel de una vez
     function actualizarTodoElPanel() {
  console.log("üîÑ ACTUALIZANDO TODO EL PANEL AUTOM√ÅTICAMENTE...");
  console.log("üìä TOTAL DE CITAS ACTUALES:", registrosPremanifiesto.length);
  
  try {
    actualizarResumenGeneral();
    actualizarCitasAgregadasHoy();
    actualizarEstadisticasSupervisoras();
    actualizarGraficoBarras();
    actualizarDetallesCitas();
  } catch (error) {
    console.error("‚ùå ERROR AL ACTUALIZAR EL PANEL:", error);
    mostrarNotificacion("ERROR AL ACTUALIZAR LA INFORMACI√ìN", 'error');
  }
}
// --- FUNCIONES DE C√ÅLCULO DE EFICIENCIA ---
      
function calcularEficienciaSupervisora(supervisora, citasHoy) {
  // ‚úÖ CAMBIO: Solo Abraham tiene 5 citas = 100%, los dem√°s mantienen 8
  const metaSupervisora = supervisora === "ABRAHAM" || supervisora === "Abraham" || supervisora.toLowerCase().includes("abraham") 
    ? 5  // Abraham: 5 citas = 100%
    : 8; // Los dem√°s: 8 citas = 100%
  
  if (citasHoy === 0) return 0;
  
  let eficiencia = Math.round((citasHoy / metaSupervisora) * 100);
  
  // Permitir eficiencia mayor al 100% si supera la meta
  if (citasHoy > metaSupervisora) {
    eficiencia = 100 + Math.round(((citasHoy - metaSupervisora) / metaSupervisora) * 100);
  }
  
  return eficiencia;
}

function obtenerTextoEficiencia(supervisora, citasHoy, eficiencia) {
  // ‚úÖ CAMBIO: Meta diferente para Abraham
  const metaSupervisora = supervisora === "ABRAHAM" || supervisora === "Abraham" || supervisora.toLowerCase().includes("abraham")
    ? 5  // Abraham: 5 citas
    : 8; // Los dem√°s: 8 citas
  
  if (eficiencia === 0) {
    return `META: ${metaSupervisora} CITAS/D√çA (${metaSupervisora} FALTANTES)`;
  }
  
  if (eficiencia >= 100) {
    const extra = eficiencia - 100;
    return `üéØ EFICIENCIA: ${eficiencia}% (${citasHoy}/${metaSupervisora} +${extra}%)`;
  }
  
  return `EFICIENCIA: ${eficiencia}% (${citasHoy}/${metaSupervisora} CITAS)`;
}

function calcularEficienciaGeneral(citasHoyTotal) {
  // ‚úÖ CAMBIO: EFICIENCIA GENERAL DEL EQUIPO ajustada para 5 supervisores
  // Considerando: Abraham (5 citas) + 4 supervisores (8 citas cada uno) = 37 citas totales para 100%
  const metaTotal = 37; // 37 citas = 100% eficiencia general entre los 5 supervisores
  let eficienciaGeneral = Math.round((citasHoyTotal / metaTotal) * 100);
  
  // Permitir eficiencia mayor al 100%
  if (citasHoyTotal > metaTotal) {
    eficienciaGeneral = 100 + Math.round(((citasHoyTotal - metaTotal) / metaTotal) * 100);
  }
  
  return eficienciaGeneral;
}

function obtenerClaseEficiencia(eficiencia) {
  if (eficiencia === 0) return 'eficiencia-baja';
  if (eficiencia < 50) return 'eficiencia-baja';
  if (eficiencia < 80) return 'eficiencia-media';
  if (eficiencia < 100) return 'eficiencia-alta';
  return 'eficiencia-excelente'; // Para > 100%
}

      // --- FUNCIONES DE ACTUALIZACI√ìN DE UI ---

      function actualizarResumenGeneral() {
        const resumenContainer = document.getElementById('resumenGeneral');
        
        // ‚úÖ CORRECCI√ìN IMPORTANTE: Contar TODAS las citas correctamente
        const totalCitas = registrosPremanifiesto.length;
        console.log("üî¢ TOTAL DE CITAS CONTADAS:", totalCitas);
        
        const hoy = new Date().toISOString().split('T')[0];
        
        // ‚úÖ CORRECCI√ìN: Contar citas de hoy correctamente
        const citasHoy = registrosPremanifiesto.filter(reg => {
          if (!reg.fechaRegistro) return false;
          
          // Buscar la fecha en cualquier formato
          const fechaReg = reg.fechaRegistro.toString();
          const hoyFormateado1 = hoy; // Formato YYYY-MM-DD
          const hoyFormateado2 = hoy.replace(/-/g, '/'); // Formato YYYY/MM/DD
          const hoyFormateado3 = new Date().toLocaleDateString('es-MX'); // Formato local
          
          return fechaReg.includes(hoyFormateado1) || 
                 fechaReg.includes(hoyFormateado2) ||
                 fechaReg.includes(hoyFormateado3) ||
                 fechaReg.includes(new Date().getDate().toString()); // Solo el d√≠a
        }).length;
        
        console.log("üìÖ CITAS HOY CONTADAS:", citasHoy);
        
        const supervisorasActivas = listaSupervisoras.length;
        const eficienciaGeneral = calcularEficienciaGeneral(citasHoy);
        
        // Determinar clase de eficiencia general
        let claseEficienciaGeneral = 'eficiencia-baja';
        if (eficienciaGeneral >= 50) claseEficienciaGeneral = 'eficiencia-media';
        if (eficienciaGeneral >= 80) claseEficienciaGeneral = 'eficiencia-alta';
        if (eficienciaGeneral >= 100) claseEficienciaGeneral = 'eficiencia-excelente';
        
        resumenContainer.innerHTML = `
          <div class="resumen-item">
            <div class="icono"><i class="fas fa-calendar-check"></i></div>
            <div class="valor" id="totalCitasCount">${totalCitas}</div>
            <div class="etiqueta">TOTAL DE CITAS</div>
            <div class="eficiencia-indicator eficiencia-excelente">
              ${totalCitas} CITAS REGISTRADAS
            </div>
          </div>
          <div class="resumen-item">
            <div class="icono"><i class="fas fa-calendar-day"></i></div>
            <div class="valor">${citasHoy}</div>
            <div class="etiqueta">CITAS HOY</div>
          </div>
          <div class="resumen-item">
            <div class="icono"><i class="fas fa-users"></i></div>
            <div class="valor">${supervisorasActivas}</div>
            <div class="etiqueta">SUPERVISORAS ACTIVAS</div>
          </div>
          <div class="resumen-item">
            <div class="icono"><i class="fas fa-chart-line"></i></div>
            <div class="valor">${eficienciaGeneral}%</div>
            <div class="etiqueta">EFICIENCIA DEL EQUIPO</div>
            <div class="eficiencia-indicator ${claseEficienciaGeneral}">
              ${eficienciaGeneral >= 100 ? 
                `üéØ SUPER√ì LA META EN ${eficienciaGeneral - 100}%` : 
                `META: ${supervisorasActivas * 8} CITAS/D√çA`}
            </div>
          </div>
        `;
      }
function actualizarCitasAgregadasHoy() {
    const citasAgregadasGrid = document.getElementById('citasAgregadasGrid');
    const hoy = new Date().toISOString().split('T')[0];
    
    const citasHoyPorSupervisora = {};
    let totalCitasHoy = 0;
    
    listaSupervisoras.forEach(supervisora => {
        const citasHoy = registrosPremanifiesto.filter(reg => 
            reg.supervisora === supervisora && 
            reg.fechaRegistro && 
            reg.fechaRegistro.toString().includes(hoy)
        ).length;
        
        citasHoyPorSupervisora[supervisora] = citasHoy;
        totalCitasHoy += citasHoy;
    });
    
    const supervisorasOrdenadas = Object.keys(citasHoyPorSupervisora).sort((a, b) => 
        citasHoyPorSupervisora[b] - citasHoyPorSupervisora[a]
    );
    
    let html = '';
    
    // Agregar fila para el total
    html += `
        <div class="cita-agregada-item" style="border-left: 4px solid var(--gold);">
            <div class="cita-agregada-supervisora">üèÜ TOTAL DE CITAS HOY</div>
            <div class="cita-agregada-cantidad">${totalCitasHoy} CITAS</div>
            <div class="cita-agregada-eficiencia eficiencia-excelente">
                ${totalCitasHoy} CITAS AGREGADAS HOY
            </div>
        </div>
    `;
    
    supervisorasOrdenadas.forEach(supervisora => {
        const citasHoy = citasHoyPorSupervisora[supervisora];
        const eficiencia = calcularEficienciaSupervisora(supervisora, citasHoy); // ‚úÖ CAMBIO: Se pasa supervisora como par√°metro
        const claseEficiencia = obtenerClaseEficiencia(eficiencia);
        const textoEficiencia = obtenerTextoEficiencia(supervisora, citasHoy, eficiencia); // ‚úÖ CAMBIO: Se pasa supervisora como par√°metro
        
        // Agregar emoji seg√∫n eficiencia
        let emoji = '‚ùå';
        if (eficiencia >= 50) emoji = '‚ö†Ô∏è';
        if (eficiencia >= 80) emoji = '‚úÖ';
        if (eficiencia >= 100) emoji = 'üéØ';
        
        // Destacar a Abraham
        const esAbraham = supervisora === "ABRAHAM" || supervisora === "Abraham" || supervisora.toLowerCase().includes("abraham");
        const destacado = esAbraham ? 'style="border-left: 4px solid var(--gold); background: rgba(212, 175, 55, 0.1);"' : '';
        
        html += `
            <div class="cita-agregada-item" ${destacado}>
                <div class="cita-agregada-supervisora">${emoji} ${supervisora} ${esAbraham ? 'üéØ' : ''}</div>
                <div class="cita-agregada-cantidad">${citasHoy} CITAS</div>
                <div class="cita-agregada-eficiencia ${claseEficiencia}">
                    ${textoEficiencia}
                    ${esAbraham ? '<br><small>META ESPECIAL: 5 CITAS = 100%</small>' : ''}
                </div>
            </div>
        `;
    });
    
    if (html === '') {
        html = '<div class="sin-datos">NO SE HAN AGREGADO CITAS HOY</div>';
    }
    
    citasAgregadasGrid.innerHTML = html;
}

      function cargarListaSupervisoras() {
        const selectFiltro = document.getElementById('filtroSupervisora');
        
        selectFiltro.innerHTML = '<option value="">TODAS LAS SUPERVISORAS</option>';
        
        listaSupervisoras.forEach(supervisora => {
          const optionFiltro = document.createElement('option');
          optionFiltro.value = supervisora;
          optionFiltro.textContent = supervisora;
          selectFiltro.appendChild(optionFiltro);
        });
      }

   function actualizarEstadisticasSupervisoras() {
    const statsContainer = document.getElementById('statsContainer');
    const filtroFecha = document.getElementById('filtroFecha').value;
    const filtroSupervisora = document.getElementById('filtroSupervisora').value;
    
    let registrosFiltrados = [...registrosPremanifiesto];
    
    if (filtroFecha) {
        registrosFiltrados = registrosFiltrados.filter(reg => 
            reg.fechaRegistro && reg.fechaRegistro.toString().includes(filtroFecha)
        );
    }
    
    if (filtroSupervisora) {
        registrosFiltrados = registrosFiltrados.filter(reg => 
            reg.supervisora === filtroSupervisora
        );
    }
    
    const statsPorSupervisora = {};
    const hoy = new Date().toISOString().split('T')[0];
    
    listaSupervisoras.forEach(supervisora => {
        const citasSupervisora = registrosFiltrados.filter(reg => reg.supervisora === supervisora);
        const citasHoy = citasSupervisora.filter(reg => 
            reg.fechaRegistro && reg.fechaRegistro.toString().includes(hoy)
        ).length;
        
        // ‚úÖ CORREGIDO: Se pasa supervisora como primer par√°metro
        const eficiencia = calcularEficienciaSupervisora(supervisora, citasHoy);
        const claseEficiencia = obtenerClaseEficiencia(eficiencia);
        const textoEficiencia = obtenerTextoEficiencia(supervisora, citasHoy, eficiencia);
        
        statsPorSupervisora[supervisora] = {
            total: citasSupervisora.length,
            hoy: citasHoy,
            eficiencia: eficiencia,
            claseEficiencia: claseEficiencia,
            textoEficiencia: textoEficiencia,
            esAbraham: supervisora === "ABRAHAM" || supervisora === "Abraham" || supervisora.toLowerCase().includes("abraham")
        };
    });
    
    const supervisorasOrdenadas = Object.keys(statsPorSupervisora).sort((a, b) => 
        statsPorSupervisora[b].total - statsPorSupervisora[a].total
    );
    
    let html = '';
    
    // Agregar tarjeta de TOTALES
    const totalCitasFiltradas = registrosFiltrados.length;
    const totalCitasHoyFiltradas = registrosFiltrados.filter(reg => 
        reg.fechaRegistro && reg.fechaRegistro.toString().includes(hoy)
    ).length;
    
    html += `
        <div class="stat-card leader">
            <h3>üèÜ TOTAL GENERAL</h3>
            <div class="count">${totalCitasFiltradas}</div>
            <div class="supervisora">TOTAL DE CITAS</div>
            <div class="conteo-dia">
                <div class="titulo">CITAS HOY</div>
                <div class="valor-dia">${totalCitasHoyFiltradas}</div>
            </div>
            <div class="eficiencia-indicator eficiencia-excelente">
                META DEL EQUIPO: 37 CITAS = 100%
            </div>
        </div>
    `;
    
    supervisorasOrdenadas.forEach((supervisora, index) => {
        const stats = statsPorSupervisora[supervisora];
        const esLider = index === 0 && stats.total > 0;
        const esAbraham = stats.esAbraham;
        
        // Destacar tarjeta de Abraham
        const claseEspecial = esAbraham ? ' style="border-top: 4px solid var(--gold); background: linear-gradient(145deg, rgba(212, 175, 55, 0.1), rgba(244, 208, 63, 0.05));"' : '';
        
        html += `
            <div class="stat-card ${esLider ? 'leader' : ''}"${claseEspecial}>
                <h3>${supervisora} ${esAbraham ? 'üéØ' : ''}</h3>
                <div class="count">${stats.total}</div>
                <div class="supervisora">TOTAL DE CITAS</div>
                <div class="conteo-dia">
                    <div class="titulo">CITAS HOY</div>
                    <div class="valor-dia">${stats.hoy}</div>
                </div>
                <div class="eficiencia-indicator ${stats.claseEficiencia}">
                    ${stats.textoEficiencia}
                </div>
                ${esLider ? '<div class="supervisora">üèÜ L√çDER DEL D√çA</div>' : ''}
                ${esAbraham ? '<div class="supervisora" style="color: var(--gold);">META ESPECIAL: 5 CITAS</div>' : ''}
            </div>
        `;
    });
    
    statsContainer.innerHTML = html || '<div class="sin-datos">NO HAY DATOS DISPONIBLES</div>';
}
      function actualizarGraficoBarras() {
        const graficoContainer = document.getElementById('graficoBarras');
        const filtroFecha = document.getElementById('filtroFecha').value;
        const filtroSupervisora = document.getElementById('filtroSupervisora').value;
        
        let registrosFiltrados = [...registrosPremanifiesto];
        
        if (filtroFecha) {
          registrosFiltrados = registrosFiltrados.filter(reg => 
            reg.fechaRegistro && reg.fechaRegistro.toString().includes(filtroFecha)
          );
        }
        
        if (filtroSupervisora) {
          registrosFiltrados = registrosFiltrados.filter(reg => 
            reg.supervisora === filtroSupervisora
          );
        }
        
        const statsPorSupervisora = {};
        const totalCitas = registrosFiltrados.length;
        
        listaSupervisoras.forEach(supervisora => {
          const citasSupervisora = registrosFiltrados.filter(reg => reg.supervisora === supervisora);
          statsPorSupervisora[supervisora] = citasSupervisora.length;
        });
        
        // Agregar "TOTAL" al gr√°fico
        statsPorSupervisora["TOTAL"] = totalCitas;
        
        const supervisorasOrdenadas = Object.keys(statsPorSupervisora).sort((a, b) => {
          if (a === "TOTAL") return -1; // Total siempre primero
          if (b === "TOTAL") return 1;
          return statsPorSupervisora[b] - statsPorSupervisora[a];
        });
        
        let html = '';
        
        supervisorasOrdenadas.forEach(supervisora => {
          const count = statsPorSupervisora[supervisora];
          const porcentaje = totalCitas > 0 ? Math.round((count / totalCitas) * 100) : 0;
          
          // Color especial para TOTAL
          const esTotal = supervisora === "TOTAL";
          const colorEspecial = esTotal ? "background: linear-gradient(90deg, var(--gold), #f4d03f);" : "";
          
          html += `
            <div class="barra">
              <div class="barra-label">${esTotal ? "üèÜ " : ""}${supervisora}</div>
              <div class="barra-progreso">
                <div class="barra-relleno" style="width: ${porcentaje}%; ${colorEspecial}">
                  ${count} (${porcentaje}%)
                </div>
              </div>
            </div>
          `;
        });
        
        graficoContainer.innerHTML = html || '<div class="sin-datos">NO HAY DATOS PARA MOSTRAR</div>';
      }

      function actualizarDetallesCitas() {
        const detalleContainer = document.getElementById('supervisoraDetalle');
        const filtroFecha = document.getElementById('filtroFecha').value;
        const filtroSupervisora = document.getElementById('filtroSupervisora').value;
        
        let registrosFiltrados = [...registrosPremanifiesto];
        
        if (filtroFecha) {
          registrosFiltrados = registrosFiltrados.filter(reg => 
            reg.fechaRegistro && reg.fechaRegistro.toString().includes(filtroFecha)
          );
        }
        
        if (filtroSupervisora) {
          registrosFiltrados = registrosFiltrados.filter(reg => 
            reg.supervisora === filtroSupervisora
          );
        }
        
        const citasPorSupervisora = {};
        
        listaSupervisoras.forEach(supervisora => {
          citasPorSupervisora[supervisora] = registrosFiltrados.filter(reg => reg.supervisora === supervisora);
        });
        
        let html = '';
        
        // Agregar secci√≥n de TOTAL primero
        if (registrosFiltrados.length > 0) {
          html += `
            <div class="supervisora-detalle">
              <h3><i class="fas fa-chart-pie"></i> TOTAL DE CITAS - ${registrosFiltrados.length} REGISTROS</h3>
              <div class="supervisora-citas">
          `;
          
          // Mostrar todas las citas (limitado a 20 para no saturar)
          const citasParaMostrar = registrosFiltrados.slice(0, 20);
          
          citasParaMostrar.forEach((cita, index) => {
            const numeroCita = cita.citaPorDia || cita.cita || (index + 1);
            const nombreCliente = cita.nombre || cita.cliente || 'CLIENTE NO ESPECIFICADO';
            const supervisoraNombre = cita.supervisora || 'SIN SUPERVISORA';
            
            html += `
              <div class="cita-item">
                <div class="cita-numero">CITA #${numeroCita}</div>
                <div class="cita-cliente">${nombreCliente}</div>
                <div class="cita-detalles">
                  <div><strong>Supervisora:</strong> ${supervisoraNombre}</div>
                  <div><strong>Fecha:</strong> ${cita.fechaRegistro || 'NO ESPECIFICADA'}</div>
                  <div><strong>Hora:</strong> ${cita.hora || 'NO ESPECIFICADA'}</div>
                  <div><small>PERSONAS: ${cita.numPersonas || 'N/A'} | EDAD: ${cita.edad || 'N/A'} | HOTEL: ${cita.hotel || 'N/A'}</small></div>
                </div>
              </div>
            `;
          });
          
          if (registrosFiltrados.length > 20) {
            html += `
              <div class="cita-item" style="text-align: center; background: rgba(30, 64, 175, 0.3);">
                <div class="cita-numero">...</div>
                <div class="cita-cliente">Y ${registrosFiltrados.length - 20} CITAS M√ÅS</div>
                <div class="cita-detalles">
                  <small>Mostrando 20 de ${registrosFiltrados.length} citas</small>
                </div>
              </div>
            `;
          }
          
          html += `
              </div>
            </div>
          `;
        }
        
        // Luego mostrar por supervisora
        Object.keys(citasPorSupervisora).forEach(supervisora => {
          const citas = citasPorSupervisora[supervisora];
          
          if (citas.length > 0) {
            html += `
              <div class="supervisora-detalle">
                <h3><i class="fas fa-user-tie"></i> ${supervisora} - ${citas.length} CITAS</h3>
                <div class="supervisora-citas">
            `;
            
            citas.forEach((cita, index) => {
              const numeroCita = cita.citaPorDia || cita.cita || (index + 1);
              const nombreCliente = cita.nombre || cita.cliente || 'CLIENTE NO ESPECIFICADO';
              
              html += `
                <div class="cita-item">
                  <div class="cita-numero">CITA #${numeroCita}</div>
                  <div class="cita-cliente">${nombreCliente}</div>
                  <div class="cita-hora">${cita.hora || 'NO ESPECIFICADA'} - ${cita.fechaRegistro || 'NO ESPECIFICADA'}</div>
                  <div class="cita-detalles">
                    <small>PERSONAS: ${cita.numPersonas || 'N/A'} | EDAD: ${cita.edad || 'N/A'} | HOTEL: ${cita.hotel || 'N/A'}</small>
                  </div>
                </div>
              `;
            });
            
            html += `
                </div>
              </div>
            `;
          }
        });
        
        detalleContainer.innerHTML = html || '<div class="sin-datos">NO HAY CITAS PARA MOSTRAR CON LOS FILTROS ACTUALES</div>';
      }

      // --- NUEVAS FUNCIONALIDADES SOLICITADAS ---

      // FUNCI√ìN PARA MOSTRAR CITAS POR RANGO DE FECHAS
      function mostrarCitasPorFechas() {
        const fechaInicio = document.getElementById('fechaInicio').value;
        const fechaFin = document.getElementById('fechaFin').value;
        
        if (!fechaInicio || !fechaFin) {
          mostrarNotificacion('SELECCIONE FECHA DE INICIO Y FIN', 'error');
          return;
        }
        
        if (new Date(fechaInicio) > new Date(fechaFin)) {
          mostrarNotificacion('LA FECHA DE INICIO DEBE SER ANTERIOR A LA DE FIN', 'error');
          return;
        }
        
        // Filtrar registros por rango de fechas (usando diaEvento)
        const registrosFiltrados = registrosPremanifiesto.filter(registro => {
          if (!registro.diaEvento) return false;
          
          const fechaEvento = new Date(registro.diaEvento);
          const inicio = new Date(fechaInicio);
          const fin = new Date(fechaFin);
          
          return fechaEvento >= inicio && fechaEvento <= fin;
        });
        
        // Mostrar modal con resultados
        mostrarModalCitasPorFechas(fechaInicio, fechaFin, registrosFiltrados);
      }

      // FUNCI√ìN PARA MOSTRAR MODAL CON CITAS POR FECHAS
      function mostrarModalCitasPorFechas(fechaInicio, fechaFin, registros) {
        const modal = document.getElementById('modalCitasMes');
        const contenido = document.getElementById('contenidoCitasMes');
        
        // Formatear fechas
        const inicioFormateada = new Date(fechaInicio).toLocaleDateString('es-MX', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        }).toUpperCase();
        
        const finFormateada = new Date(fechaFin).toLocaleDateString('es-MX', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        }).toUpperCase();
        
        // Agrupar por d√≠as
        const citasPorDia = {};
        
        registros.forEach(registro => {
          const fecha = registro.diaEvento;
          
          if (fecha) {
            if (!citasPorDia[fecha]) {
              citasPorDia[fecha] = [];
            }
            citasPorDia[fecha].push(registro);
          }
        });
        
        // Ordenar fechas y excluir lunes
        const fechasOrdenadas = Object.keys(citasPorDia).sort();
        const fechasFiltradas = fechasOrdenadas.filter(fecha => {
          const fechaObj = new Date(fecha);
          return fechaObj.getDay() !== 1; // Excluir lunes (1 = lunes)
        });
        
        // Generar HTML
        let html = `
          <div class="modal-header">
            <h3><i class="fas fa-calendar-alt"></i> PREMANIFIESTO DEL ${inicioFormateada} AL ${finFormateada}</h3>
            <span class="cerrar-modal">&times;</span>
          </div>
          
          <div class="resumen-citas-mes">
            <div class="resumen-mes-item">
              <div class="titulo">TOTAL DE CITAS</div>
              <div class="valor">${registros.length}</div>
              <div class="detalle">En el per√≠odo seleccionado</div>
            </div>
            <div class="resumen-mes-item">
              <div class="titulo">D√çAS CON CITAS</div>
              <div class="valor">${fechasFiltradas.length}</div>
              <div class="detalle">Excluyendo lunes</div>
            </div>
            <div class="resumen-mes-item">
              <div class="titulo">PROMEDIO POR D√çA</div>
              <div class="valor">${fechasFiltradas.length > 0 ? Math.round(registros.length / fechasFiltradas.length) : 0}</div>
              <div class="detalle">Citas por d√≠a</div>
            </div>
          </div>
          
          <div class="pestanas-mes" id="pestanasMes">
        `;
        
        // Agregar pesta√±as para cada d√≠a (excluyendo lunes)
        fechasFiltradas.forEach((fecha, index) => {
          const fechaObj = new Date(fecha);
          const dia = fechaObj.getDate();
          const mes = fechaObj.toLocaleDateString('es-MX', { month: 'short' }).toUpperCase().replace('.', '');
          
          // Nombre de la pesta√±a: PREMANIFIESTO DEL 01 DE DIC
          html += `
            <div class="pestana-dia ${index === 0 ? 'activa' : ''}" data-fecha="${fecha}">
              PREMANIFIESTO DEL ${dia.toString().padStart(2, '0')} DE ${mes}
            </div>
          `;
        });
        
        html += `</div>`;
        
        // Contenido para cada d√≠a
        fechasFiltradas.forEach((fecha, index) => {
          const citasDelDia = citasPorDia[fecha];
          const fechaObj = new Date(fecha);
          const nombreDiaCompleto = fechaObj.toLocaleDateString('es-MX', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
          }).toUpperCase();
          
          html += `
            <div class="contenido-pestana ${index === 0 ? 'activa' : ''}" id="contenido-${fecha}">
              <h4>${nombreDiaCompleto}</h4>
              
              <div class="resumen-citas-mes" style="margin-bottom: 20px;">
                <div class="resumen-mes-item">
                  <div class="titulo">TOTAL CITAS</div>
                  <div class="valor">${citasDelDia.length}</div>
                  <div class="detalle">Este d√≠a</div>
                </div>
                <div class="resumen-mes-item">
                  <div class="titulo">SUPERVISORAS</div>
                  <div class="valor">${[...new Set(citasDelDia.map(c => c.supervisora))].length}</div>
                  <div class="detalle">Participantes</div>
                </div>
                <div class="resumen-mes-item">
                  <div class="titulo">PERSONAS</div>
                  <div class="valor">${citasDelDia.reduce((sum, c) => sum + (parseInt(c.numPersonas) || 0), 0)}</div>
                  <div class="detalle">Total asistentes</div>
                </div>
              </div>
              
              <div style="overflow-x: auto; margin-top: 20px;">
                <table style="width: 100%; border-collapse: collapse; background: rgba(30, 41, 59, 0.7);">
                  <thead>
                    <tr style="background: var(--primary);">
                      <th style="padding: 12px; border: 1px solid var(--primary-light); text-align: center;">NUM DE CITA</th>
                      <th style="padding: 12px; border: 1px solid var(--primary-light); text-align: center;">FECHA</th>
                      <th style="padding: 12px; border: 1px solid var(--primary-light); text-align: center;">PAX</th>
                      <th style="padding: 12px; border: 1px solid var(--primary-light); text-align: center;">NOMBRES FAMILIA</th>
                      <th style="padding: 12px; border: 1px solid var(--primary-light); text-align: center;">EDAD</th>
                      <th style="padding: 12px; border: 1px solid var(--primary-light); text-align: center;">ESTADO CIVIL</th>
                      <th style="padding: 12px; border: 1px solid var(--primary-light); text-align: center;">TARJETAS</th>
                      <th style="padding: 12px; border: 1px solid var(--primary-light); text-align: center;">ID</th>
                      <th style="padding: 12px; border: 1px solid var(--primary-light); text-align: center;">INGRESOS</th>
                      <th style="padding: 12px; border: 1px solid var(--primary-light); text-align: center;">VENDEDOR</th>
                      <th style="padding: 12px; border: 1px solid var(--primary-light); text-align: center;">OPERADOR</th>
                      <th style="padding: 12px; border: 1px solid var(--primary-light); text-align: center;">GERENTE</th>
                      <th style="padding: 12px; border: 1px solid var(--primary-light); text-align: center;">SPA</th>
                    </tr>
                  </thead>
                  <tbody>
          `;
          
          // Ordenar citas por n√∫mero de cita
          const citasOrdenadas = [...citasDelDia].sort((a, b) => {
            const numA = a.citaPorDia || 0;
            const numB = b.citaPorDia || 0;
            return numA - numB;
          });
          
          citasOrdenadas.forEach((cita, idx) => {
            const numeroCita = cita.citaPorDia || idx + 1;
            const fechaFormateada = fechaObj.toISOString().split('T')[0];
            
            html += `
              <tr style="${idx % 2 === 0 ? 'background: rgba(30, 41, 59, 0.5);' : 'background: rgba(30, 41, 59, 0.8);'}">
                <td style="padding: 10px; border: 1px solid var(--primary-light); text-align: center;">${numeroCita}</td>
                <td style="padding: 10px; border: 1px solid var(--primary-light); text-align: center;">${fechaFormateada}</td>
                <td style="padding: 10px; border: 1px solid var(--primary-light); text-align: center;">${cita.numPersonas || ''}</td>
                <td style="padding: 10px; border: 1px solid var(--primary-light);">${cita.nombre || ''}</td>
                <td style="padding: 10px; border: 1px solid var(--primary-light); text-align: center;">${cita.edad || ''}</td>
                <td style="padding: 10px; border: 1px solid var(--primary-light); text-align: center;">${cita.estadoCivil || ''}</td>
                <td style="padding: 10px; border: 1px solid var(--primary-light); text-align: center;">${cita.tarjeta || ''}</td>
                <td style="padding: 10px; border: 1px solid var(--primary-light); text-align: center;">---</td>
                <td style="padding: 10px; border: 1px solid var(--primary-light); text-align: center;">${cita.ingresos || ''}</td>
                <td style="padding: 10px; border: 1px solid var(--primary-light); text-align: center;">${cita.vendedor || ''}</td>
                <td style="padding: 10px; border: 1px solid var(--primary-light); text-align: center;">${cita.operador || ''}</td>
                <td style="padding: 10px; border: 1px solid var(--primary-light); text-align: center;">${cita.gerente || ''}</td>
                <td style="padding: 10px; border: 1px solid var(--primary-light); text-align: center;">RESTAURANTE</td>
              </tr>
            `;
          });
          
          html += `
                  </tbody>
                </table>
              </div>
            </div>
          `;
        });
        
        contenido.innerHTML = html;
        modal.style.display = 'block';
        
        // Configurar eventos para las pesta√±as
        configurarPestanasModal();
      }

      // FUNCI√ìN PARA CONFIGURAR PESTA√ëAS DEL MODAL
      function configurarPestanasModal() {
        const pestanas = document.querySelectorAll('.pestana-dia');
        pestanas.forEach(pestana => {
          pestana.addEventListener('click', function() {
            const fecha = this.getAttribute('data-fecha');
            
            // Remover clase activa de todas las pesta√±as
            pestanas.forEach(p => p.classList.remove('activa'));
            // Agregar clase activa a la pesta√±a clickeada
            this.classList.add('activa');
            
            // Ocultar todos los contenidos
            document.querySelectorAll('.contenido-pestana').forEach(contenido => {
              contenido.classList.remove('activa');
            });
            
            // Mostrar el contenido correspondiente
            document.getElementById(`contenido-${fecha}`).classList.add('activa');
          });
        });
      }

      // FUNCI√ìN PARA DESCARGAR PREMANIFIESTO DEL MES COMPLETO
      function descargarPremanifiestoMesCompleto() {
        const hoy = new Date();
        const mesActual = hoy.getMonth();
        const a√±oActual = hoy.getFullYear();
        const mesNombre = hoy.toLocaleDateString('es-MX', { month: 'long' }).toUpperCase();
        
        // Obtener todos los registros del mes actual
        const registrosMes = registrosPremanifiesto.filter(registro => {
          if (!registro.diaEvento) return false;
          
          const fechaEvento = new Date(registro.diaEvento);
          return fechaEvento.getMonth() === mesActual && fechaEvento.getFullYear() === a√±oActual;
        });
        
        if (registrosMes.length === 0) {
          mostrarNotificacion('NO HAY REGISTROS PARA EL MES ACTUAL', 'error');
          return;
        }
        
        // Agrupar por d√≠a y excluir lunes
        const registrosPorDia = {};
        registrosMes.forEach(registro => {
          const fecha = registro.diaEvento;
          const fechaObj = new Date(fecha);
          
          // Excluir lunes (d√≠a 1 = lunes)
          if (fechaObj.getDay() === 1) return;
          
          if (!registrosPorDia[fecha]) {
            registrosPorDia[fecha] = [];
          }
          registrosPorDia[fecha].push(registro);
        });
        
        // Ordenar fechas
        const fechasOrdenadas = Object.keys(registrosPorDia).sort();
        
        if (fechasOrdenadas.length === 0) {
          mostrarNotificacion('NO HAY REGISTROS PARA D√çAS QUE NO SEAN LUNES', 'error');
          return;
        }
        
        // Crear libro de Excel
        const workbook = new ExcelJS.Workbook();
        
        // HOJA 1: RESUMEN GENERAL
        const resumenWorksheet = workbook.addWorksheet("RESUMEN MES");
        
        // T√≠tulo
        resumenWorksheet.addRow([`PREMANIFIESTO MENSUAL - ${mesNombre} ${a√±oActual}`]);
        resumenWorksheet.mergeCells('A1:M1');
        const tituloRow = resumenWorksheet.getRow(1);
        tituloRow.font = { size: 18, bold: true, color: { argb: 'FF1E40AF' } };
        tituloRow.alignment = { horizontal: 'center' };
        
        resumenWorksheet.addRow([`GENERADO EL: ${new Date().toLocaleDateString('es-MX')}`]);
        resumenWorksheet.mergeCells('A2:M2');
        const fechaRow = resumenWorksheet.getRow(2);
        fechaRow.font = { bold: true };
        fechaRow.alignment = { horizontal: 'center' };
        
        resumenWorksheet.addRow([]);
        
        // Estad√≠sticas por d√≠a
        resumenWorksheet.addRow(['D√çA', 'FECHA', 'TOTAL CITAS', 'SUPERVISORAS', 'TOTAL PERSONAS', 'PROMEDIO PERSONAS/CITA']);
        const headerRow = resumenWorksheet.getRow(4);
        headerRow.eachCell((cell) => {
          cell.fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FF1E40AF' }
          };
          cell.font = { bold: true, color: { argb: 'FFFFFFFF' } };
          cell.alignment = { horizontal: 'center' };
          cell.border = {
            top: { style: 'thin' },
            left: { style: 'thin' },
            bottom: { style: 'thin' },
            right: { style: 'thin' }
          };
        });
        
        let filaActual = 5;
        let totalCitasMes = 0;
        let totalPersonasMes = 0;
        
        fechasOrdenadas.forEach((fecha, index) => {
          const fechaObj = new Date(fecha);
          const diaNombre = fechaObj.toLocaleDateString('es-MX', { weekday: 'long' }).toUpperCase();
          const diaNumero = fechaObj.getDate();
          const registrosDelDia = registrosPorDia[fecha];
          
          const totalCitas = registrosDelDia.length;
          const supervisoras = [...new Set(registrosDelDia.map(r => r.supervisora))].length;
          const totalPersonas = registrosDelDia.reduce((sum, r) => sum + (parseInt(r.numPersonas) || 0), 0);
          const promedioPersonas = totalPersonas / totalCitas;
          
          resumenWorksheet.addRow([
            diaNombre,
            fecha,
            totalCitas,
            supervisoras,
            totalPersonas,
            promedioPersonas.toFixed(1)
          ]);
          
          totalCitasMes += totalCitas;
          totalPersonasMes += totalPersonas;
          
          filaActual++;
        });
        
        // Totales
        resumenWorksheet.addRow([]);
        resumenWorksheet.addRow(['TOTAL MES', '', totalCitasMes, '', totalPersonasMes, (totalPersonasMes / totalCitasMes).toFixed(1)]);
        const totalRow = resumenWorksheet.getRow(filaActual + 2);
        totalRow.font = { bold: true };
        totalRow.eachCell((cell) => {
          cell.fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FFFFF3CD' }
          };
        });
        
        // Estad√≠sticas por supervisora
        resumenWorksheet.addRow([]);
        resumenWorksheet.addRow([]);
        
        const estadisticasSupervisora = {};
        registrosMes.forEach(registro => {
          const supervisora = registro.supervisora || 'SIN SUPERVISORA';
          if (!estadisticasSupervisora[supervisora]) {
            estadisticasSupervisora[supervisora] = { citas: 0, personas: 0 };
          }
          estadisticasSupervisora[supervisora].citas++;
          estadisticasSupervisora[supervisora].personas += parseInt(registro.numPersonas) || 0;
        });
        
        resumenWorksheet.addRow(['ESTAD√çSTICAS POR SUPERVISORA']);
        resumenWorksheet.mergeCells(`A${filaActual + 5}:F${filaActual + 5}`);
        const statsHeader = resumenWorksheet.getRow(filaActual + 5);
        statsHeader.font = { size: 14, bold: true, color: { argb: 'FF10B981' } };
        statsHeader.alignment = { horizontal: 'center' };
        
        resumenWorksheet.addRow(['SUPERVISORA', 'TOTAL CITAS', 'TOTAL PERSONAS', 'PROMEDIO PERSONAS/CITA', '% DEL TOTAL']);
        const statsSubHeader = resumenWorksheet.getRow(filaActual + 6);
        statsSubHeader.eachCell((cell) => {
          cell.fill = {
            type: 'pattern',
            pattern: 'solid',
            fgColor: { argb: 'FF10B981' }
          };
          cell.font = { bold: true, color: { argb: 'FFFFFFFF' } };
          cell.alignment = { horizontal: 'center' };
        });
        
        Object.keys(estadisticasSupervisora).forEach(supervisora => {
          const stats = estadisticasSupervisora[supervisora];
          const promedio = stats.personas / stats.citas;
          const porcentaje = (stats.citas / totalCitasMes * 100).toFixed(1);
          
          resumenWorksheet.addRow([
            supervisora,
            stats.citas,
            stats.personas,
            promedio.toFixed(1),
            `${porcentaje}%`
          ]);
        });
        
        // HOJAS POR D√çA (excluyendo lunes)
        fechasOrdenadas.forEach((fecha, diaIndex) => {
          const fechaObj = new Date(fecha);
          const diaNombre = fechaObj.toLocaleDateString('es-MX', { weekday: 'long' }).toUpperCase();
          const diaNumero = fechaObj.getDate();
          const mesDia = fechaObj.toLocaleDateString('es-MX', { month: 'short' }).toUpperCase().replace('.', '');
          
          // Nombre de la hoja: PREMANIFIESTO 01 DIC
          const nombreHoja = `PREMANIFIESTO ${diaNumero.toString().padStart(2, '0')} ${mesDia}`.substring(0, 31);
          const worksheet = workbook.addWorksheet(nombreHoja);
          
          // T√≠tulo de la hoja
          const tituloDia = `PREMANIFIESTO DEL ${diaNombre}, ${diaNumero} DE ${mesNombre} DE ${a√±oActual}`;
          worksheet.addRow([tituloDia]);
          worksheet.mergeCells('A1:M1');
          const tituloDiaRow = worksheet.getRow(1);
          tituloDiaRow.font = { size: 16, bold: true, color: { argb: 'FF1E40AF' } };
          tituloDiaRow.alignment = { horizontal: 'center' };
          
          worksheet.addRow([]);
          
          // Encabezados exactos como en la imagen
          const headers = [
            'NUM DE CITA', 'FECHA', 'PAX', 'NOMBRES FAMILIA', 'EDAD', 
            'ESTADO CIVIL', 'TARJETAS', 'ID', 'INGRESOS', 'VENDEDOR', 
            'OPERADOR', 'GERENTE', 'SPA'
          ];
          
          const headerRowDia = worksheet.addRow(headers);
          headerRowDia.eachCell((cell) => {
            cell.fill = {
              type: 'pattern',
              pattern: 'solid',
              fgColor: { argb: 'FF0F172A' }
            };
            cell.font = {
              bold: true,
              color: { argb: 'FFFFFFFF' }
            };
            cell.alignment = { horizontal: 'center', vertical: 'middle' };
            cell.border = {
              top: { style: 'thin', color: { argb: 'FF000000' } },
              left: { style: 'thin', color: { argb: 'FF000000' } },
              bottom: { style: 'thin', color: { argb: 'FF000000' } },
              right: { style: 'thin', color: { argb: 'FF000000' } }
            };
          });
          
          // Agregar datos
          const registrosDelDia = registrosPorDia[fecha];
          const citasOrdenadas = [...registrosDelDia].sort((a, b) => {
            const numA = a.citaPorDia || 0;
            const numB = b.citaPorDia || 0;
            return numA - numB;
          });
          
          citasOrdenadas.forEach((registro, index) => {
            const numeroCita = registro.citaPorDia || (index + 1);
            
            const rowData = [
              numeroCita,
              fecha,
              registro.numPersonas || '',
              registro.nombre || '',
              registro.edad || '',
              registro.estadoCivil || '',
              registro.tarjeta || '',
              '---', // ID siempre como ---
              registro.ingresos || '',
              registro.vendedor || '',
              registro.operador || '',
              registro.gerente || '',
              'RESTAURANTE' // SPA siempre como RESTAURANTE
            ];
            
            const row = worksheet.addRow(rowData);
            
            // Alternar colores de fila
            if (index % 2 === 0) {
              row.eachCell((cell) => {
                cell.fill = {
                  type: 'pattern',
                  pattern: 'solid',
                  fgColor: { argb: 'FFF8FAFC' }
                };
              });
            }
            
            row.eachCell((cell) => {
              cell.border = {
                top: { style: 'thin', color: { argb: 'FFCBD5E1' } },
                left: { style: 'thin', color: { argb: 'FFCBD5E1' } },
                bottom: { style: 'thin', color: { argb: 'FFCBD5E1' } },
                right: { style: 'thin', color: { argb: 'FFCBD5E1' } }
              };
              cell.alignment = { vertical: 'middle' };
            });
          });
          
          // Ajustar anchos de columnas
          worksheet.columns = [
            { width: 12 }, // NUM DE CITA
            { width: 12 }, // FECHA
            { width: 8 },  // PAX
            { width: 35 }, // NOMBRES FAMILIA
            { width: 10 }, // EDAD
            { width: 15 }, // ESTADO CIVIL
            { width: 15 }, // TARJETAS
            { width: 10 }, // ID
            { width: 12 }, // INGRESOS
            { width: 15 }, // VENDEDOR
            { width: 15 }, // OPERADOR
            { width: 15 }, // GERENTE
            { width: 12 }  // SPA
          ];
          
          // Resumen al final de la hoja
          const totalCitasDia = registrosDelDia.length;
          const totalPersonasDia = registrosDelDia.reduce((sum, r) => sum + (parseInt(r.numPersonas) || 0), 0);
          const supervisorasDia = [...new Set(registrosDelDia.map(r => r.supervisora))].length;
          
          worksheet.addRow([]);
          worksheet.addRow(['RESUMEN DEL D√çA:', '', '', '', '', '', '', '', '', '', '', '', '']);
          const resumenHeader = worksheet.getRow(worksheet.rowCount);
          resumenHeader.font = { bold: true, size: 12 };
          
          worksheet.addRow(['TOTAL CITAS:', totalCitasDia]);
          worksheet.addRow(['TOTAL PERSONAS:', totalPersonasDia]);
          worksheet.addRow(['SUPERVISORAS:', supervisorasDia]);
          worksheet.addRow(['PROMEDIO PERSONAS/CITA:', (totalPersonasDia / totalCitasDia).toFixed(1)]);
        });
        
        // Generar y descargar archivo
        workbook.xlsx.writeBuffer().then(buffer => {
          const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
          const nombreMes = mesNombre.toLowerCase();
          const nombreArchivo = `PREMANIFIESTO_COMPLETO_${nombreMes}_${a√±oActual}.xlsx`;
          
          saveAs(blob, nombreArchivo);
          mostrarNotificacion(`PREMANIFIESTO COMPLETO DE ${mesNombre} DESCARGADO CORRECTAMENTE`);
        }).catch(error => {
          console.error('Error al generar Excel:', error);
          mostrarNotificacion('ERROR AL GENERAR EL ARCHIVO', 'error');
        });
      }

      // ‚úÖ FUNCI√ìN CORREGIDA: MOSTRAR CITAS DEL MES
      function mostrarCitasDelMes() {
        const modal = document.getElementById('modalCitasMes');
        const contenido = document.getElementById('contenidoCitasMes');
        
        // Obtener el mes actual
        const hoy = new Date();
        const a√±o = hoy.getFullYear();
        const mes = hoy.getMonth();
        
        // Obtener todos los d√≠as del mes
        const diasDelMes = new Date(a√±o, mes + 1, 0).getDate();
        
        // Agrupar citas por d√≠a usando diaEvento y excluir lunes
        const citasPorDia = {};
        let totalCitasMes = 0;
        
        for (let dia = 1; dia <= diasDelMes; dia++) {
          const fecha = `${a√±o}-${String(mes + 1).padStart(2, '0')}-${String(dia).padStart(2, '0')}`;
          const fechaObj = new Date(fecha);
          
          // Excluir lunes (d√≠a 1 = lunes)
          if (fechaObj.getDay() === 1) continue;
          
          const citasDia = registrosPremanifiesto.filter(registro => 
            registro.diaEvento === fecha
          );
          
          if (citasDia.length > 0) {
            citasPorDia[fecha] = citasDia;
            totalCitasMes += citasDia.length;
          }
        }
        
        // Generar HTML para el modal
        let html = `
          <div class="resumen-citas-mes">
            <div class="resumen-mes-item">
              <div class="titulo">TOTAL DE CITAS DEL MES</div>
              <div class="valor">${totalCitasMes}</div>
              <div class="detalle">Excluyendo lunes</div>
            </div>
            <div class="resumen-mes-item">
              <div class="titulo">D√çAS CON CITAS</div>
              <div class="valor">${Object.keys(citasPorDia).length}</div>
              <div class="detalle">Este mes</div>
            </div>
            <div class="resumen-mes-item">
              <div class="titulo">PROMEDIO POR D√çA</div>
              <div class="valor">${Object.keys(citasPorDia).length > 0 ? Math.round(totalCitasMes / Object.keys(citasPorDia).length) : 0}</div>
              <div class="detalle">Citas por d√≠a</div>
            </div>
          </div>
          
          <div class="pestanas-mes" id="pestanasMes">
        `;
        
        // Crear pesta√±as para cada d√≠a con citas (excluyendo lunes)
        Object.keys(citasPorDia).sort().forEach((fecha, index) => {
          const fechaObj = new Date(fecha);
          const dia = fechaObj.getDate();
          const mes = fechaObj.toLocaleDateString('es-MX', { month: 'short' }).toUpperCase().replace('.', '');
          
          html += `
            <div class="pestana-dia ${index === 0 ? 'activa' : ''}" data-fecha="${fecha}">
              PREMANIFIESTO DEL ${dia.toString().padStart(2, '0')} DE ${mes}
            </div>
          `;
        });
        
        html += `</div>`;
        
        // Crear contenido para cada pesta√±a
        Object.keys(citasPorDia).sort().forEach((fecha, index) => {
          const citasDia = citasPorDia[fecha];
          const fechaObj = new Date(fecha);
          const nombreDiaCompleto = fechaObj.toLocaleDateString('es-MX', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
          }).toUpperCase();
          
          html += `
            <div class="contenido-pestana ${index === 0 ? 'activa' : ''}" id="contenido-${fecha}">
              <h4>${nombreDiaCompleto}</h4>
              
              <div class="resumen-citas-mes" style="margin-bottom: 20px;">
                <div class="resumen-mes-item">
                  <div class="titulo">TOTAL CITAS</div>
                  <div class="valor">${citasDia.length}</div>
                  <div class="detalle">Este d√≠a</div>
                </div>
                <div class="resumen-mes-item">
                  <div class="titulo">SUPERVISORAS</div>
                  <div class="valor">${[...new Set(citasDia.map(c => c.supervisora))].length}</div>
                  <div class="detalle">Participantes</div>
                </div>
                <div class="resumen-mes-item">
                  <div class="titulo">PERSONAS</div>
                  <div class="valor">${citasDia.reduce((sum, c) => sum + (parseInt(c.numPersonas) || 0), 0)}</div>
                  <div class="detalle">Total asistentes</div>
                </div>
              </div>
              
              <div style="overflow-x: auto; margin-top: 20px;">
                <table style="width: 100%; border-collapse: collapse; background: rgba(30, 41, 59, 0.7);">
                  <thead>
                    <tr style="background: var(--primary);">
                      <th style="padding: 12px; border: 1px solid var(--primary-light); text-align: center;">NUM DE CITA</th>
                      <th style="padding: 12px; border: 1px solid var(--primary-light); text-align: center;">FECHA</th>
                      <th style="padding: 12px; border: 1px solid var(--primary-light); text-align: center;">PAX</th>
                      <th style="padding: 12px; border: 1px solid var(--primary-light); text-align: center;">NOMBRES FAMILIA</th>
                      <th style="padding: 12px; border: 1px solid var(--primary-light); text-align: center;">EDAD</th>
                      <th style="padding: 12px; border: 1px solid var(--primary-light); text-align: center;">ESTADO CIVIL</th>
                      <th style="padding: 12px; border: 1px solid var(--primary-light); text-align: center;">TARJETAS</th>
                      <th style="padding: 12px; border: 1px solid var(--primary-light); text-align: center;">ID</th>
                      <th style="padding: 12px; border: 1px solid var(--primary-light); text-align: center;">INGRESOS</th>
                      <th style="padding: 12px; border: 1px solid var(--primary-light); text-align: center;">VENDEDOR</th>
                      <th style="padding: 12px; border: 1px solid var(--primary-light); text-align: center;">OPERADOR</th>
                      <th style="padding: 12px; border: 1px solid var(--primary-light); text-align: center;">GERENTE</th>
                      <th style="padding: 12px; border: 1px solid var(--primary-light); text-align: center;">SPA</th>
                    </tr>
                  </thead>
                  <tbody>
          `;
          
          // Ordenar citas por n√∫mero de cita
          const citasOrdenadas = [...citasDia].sort((a, b) => {
            const numA = a.citaPorDia || 0;
            const numB = b.citaPorDia || 0;
            return numA - numB;
          });
          
          citasOrdenadas.forEach((cita, idx) => {
            const numeroCita = cita.citaPorDia || idx + 1;
            const fechaFormateada = fechaObj.toISOString().split('T')[0];
            
            html += `
              <tr style="${idx % 2 === 0 ? 'background: rgba(30, 41, 59, 0.5);' : 'background: rgba(30, 41, 59, 0.8);'}">
                <td style="padding: 10px; border: 1px solid var(--primary-light); text-align: center;">${numeroCita}</td>
                <td style="padding: 10px; border: 1px solid var(--primary-light); text-align: center;">${fechaFormateada}</td>
                <td style="padding: 10px; border: 1px solid var(--primary-light); text-align: center;">${cita.numPersonas || ''}</td>
                <td style="padding: 10px; border: 1px solid var(--primary-light);">${cita.nombre || ''}</td>
                <td style="padding: 10px; border: 1px solid var(--primary-light); text-align: center;">${cita.edad || ''}</td>
                <td style="padding: 10px; border: 1px solid var(--primary-light); text-align: center;">${cita.estadoCivil || ''}</td>
                <td style="padding: 10px; border: 1px solid var(--primary-light); text-align: center;">${cita.tarjeta || ''}</td>
                <td style="padding: 10px; border: 1px solid var(--primary-light); text-align: center;">---</td>
                <td style="padding: 10px; border: 1px solid var(--primary-light); text-align: center;">${cita.ingresos || ''}</td>
                <td style="padding: 10px; border: 1px solid var(--primary-light); text-align: center;">${cita.vendedor || ''}</td>
                <td style="padding: 10px; border: 1px solid var(--primary-light); text-align: center;">${cita.operador || ''}</td>
                <td style="padding: 10px; border: 1px solid var(--primary-light); text-align: center;">${cita.gerente || ''}</td>
                <td style="padding: 10px; border: 1px solid var(--primary-light); text-align: center;">RESTAURANTE</td>
              </tr>
            `;
          });
          
          html += `
                  </tbody>
                </table>
              </div>
            </div>
          `;
        });
        
        contenido.innerHTML = html;
        modal.style.display = 'block';
        
        // Configurar eventos para las pesta√±as
        const pestanas = document.querySelectorAll('.pestana-dia');
        pestanas.forEach(pestana => {
          pestana.addEventListener('click', function() {
            const fecha = this.getAttribute('data-fecha');
            
            // Remover clase activa de todas las pesta√±as
            pestanas.forEach(p => p.classList.remove('activa'));
            // Agregar clase activa a la pesta√±a clickeada
            this.classList.add('activa');
            
            // Ocultar todos los contenidos
            document.querySelectorAll('.contenido-pestana').forEach(contenido => {
              contenido.classList.remove('activa');
            });
            
            // Mostrar el contenido correspondiente
            document.getElementById(`contenido-${fecha}`).classList.add('activa');
          });
        });
      }

      function mostrarNotificacion(mensaje, tipo = 'success') {
        const notificacion = document.createElement('div');
        notificacion.innerHTML = `<i class="fas fa-${tipo === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i> ${mensaje}`;
        notificacion.className = `notificacion ${tipo === 'error' ? 'error' : ''}`;
        
        document.body.appendChild(notificacion);
        
        setTimeout(() => {
          if (notificacion.parentNode) {
            document.body.removeChild(notificacion);
          }
        }, 4000);
      }

      // --- INICIALIZACI√ìN ---

      function inicializarSistema() {
        console.log("üöÄ INICIALIZANDO SISTEMA DE TIEMPO REAL...");
        
        configurarFirebase();
        
        const hoy = new Date();
        const fechaInicioInput = document.getElementById('fechaInicio');
        const fechaFinInput = document.getElementById('fechaFin');
        
        // Configurar fechas por defecto (primer d√≠a del mes hasta hoy)
        const primerDiaMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
        const hoyFormateado = hoy.toISOString().split('T')[0];
        
        document.getElementById('filtroFecha').value = hoyFormateado;
        
        if (fechaInicioInput && fechaFinInput) {
          fechaInicioInput.value = primerDiaMes.toISOString().split('T')[0];
          fechaFinInput.value = hoyFormateado;
        }
        
        configurarEventListeners();
        
        console.log("‚úÖ SISTEMA INICIALIZADO CORRECTAMENTE - LISTO PARA ACTUALIZACIONES EN TIEMPO REAL");
      }

      function configurarEventListeners() {
        const actualizarBtn = document.getElementById('actualizarBtn');
        const exportarBtn = document.getElementById('exportarEstadisticas');
        const aplicarFiltroBtn = document.getElementById('aplicarFiltro');
        const limpiarFiltroBtn = document.getElementById('limpiarFiltro');
        const btnCitasMes = document.getElementById('btnCitasMes');
        const btnBuscarPorFechas = document.getElementById('btnBuscarPorFechas');
        const btnDescargarMes = document.getElementById('btnDescargarMes');
        const modal = document.getElementById('modalCitasMes');
        const cerrarModal = document.querySelector('.cerrar-modal');
        
        if (!actualizarBtn || !exportarBtn || !aplicarFiltroBtn || !limpiarFiltroBtn) {
          console.error("‚ùå NO SE ENCONTRARON TODOS LOS ELEMENTOS DEL DOM");
          setTimeout(configurarEventListeners, 1000);
          return;
        }
        
        actualizarBtn.addEventListener('click', function() {
          const btn = this;
          const icono = btn.querySelector('i');
          
          icono.classList.add('actualizando');
          btn.disabled = true;
          
          setTimeout(() => {
            actualizarTodoElPanel();
            icono.classList.remove('actualizando');
            btn.disabled = false;
            mostrarNotificacion('DATOS ACTUALIZADOS MANUALMENTE - ' + registrosPremanifiesto.length + ' CITAS');
          }, 1000);
        });
        
        aplicarFiltroBtn.addEventListener('click', function() {
          actualizarTodoElPanel();
        });
        
        limpiarFiltroBtn.addEventListener('click', function() {
          document.getElementById('filtroFecha').value = new Date().toISOString().split('T')[0];
          document.getElementById('filtroSupervisora').value = '';
          actualizarTodoElPanel();
        });
        
        exportarBtn.addEventListener("click", function() {
          exportarEstadisticasConRegistros();
        });
        
        btnCitasMes.addEventListener('click', mostrarCitasDelMes);
        
        // NUEVOS EVENT LISTENERS
        if (btnBuscarPorFechas) {
          btnBuscarPorFechas.addEventListener('click', mostrarCitasPorFechas);
        }
        
        if (btnDescargarMes) {
          btnDescargarMes.addEventListener('click', descargarPremanifiestoMesCompleto);
        }
        
        cerrarModal.addEventListener('click', function() {
          modal.style.display = 'none';
        });
        
        window.addEventListener('click', function(event) {
          if (event.target === modal) {
            modal.style.display = 'none';
          }
        });
      }

      // ‚úÖ FUNCI√ìN CORREGIDA: Exportar estad√≠sticas con informaci√≥n de registros
      function exportarEstadisticasConRegistros() {
        if (registrosPremanifiesto.length === 0) {
          mostrarNotificacion("NO HAY DATOS PARA EXPORTAR", 'error');
          return;
        }

        try {
          const workbook = new ExcelJS.Workbook();
          
          // Obtener filtros actuales
          const filtroFecha = document.getElementById('filtroFecha').value;
          const filtroSupervisora = document.getElementById('filtroSupervisora').value;
          
          // Hoja de RESUMEN GENERAL
          const wsResumen = workbook.addWorksheet("RESUMEN GENERAL");
          
          // T√≠tulo personalizado seg√∫n filtros
          let tituloPrincipal = "REPORTE DE ESTAD√çSTICAS - BLUE ELEGANCE";
          
          if (filtroFecha && filtroSupervisora) {
            const fechaInicioFormateada = new Date(filtroFecha).toLocaleDateString('es-MX');
            
            tituloPrincipal = `CITAS DE ${filtroSupervisora} - ${fechaInicioFormateada}`;
          }
          
          const tituloRow = wsResumen.addRow([tituloPrincipal]);
          tituloRow.font = { size: 16, bold: true };
          tituloRow.alignment = { horizontal: 'center' };
          wsResumen.mergeCells('A1:F1');
          
          const fechaRow = wsResumen.addRow([`GENERADO EL: ${new Date().toLocaleString('es-MX')}`]);
          fechaRow.font = { bold: true };
          wsResumen.mergeCells('A2:F2');
          
          wsResumen.addRow([]);
          
          const totalCitas = registrosPremanifiesto.length;
          const supervisorasActivas = listaSupervisoras.length;
          const hoy = new Date().toISOString().split('T')[0];
          const citasHoy = registrosPremanifiesto.filter(reg => reg.fechaRegistro && reg.fechaRegistro.toString().includes(hoy)).length;
          const eficienciaGeneral = calcularEficienciaGeneral(citasHoy);
          
          wsResumen.addRow(["ESTAD√çSTICAS GENERALES", "", "", "", "", ""]);
          wsResumen.addRow(["TOTAL DE CITAS REGISTRADAS:", totalCitas]);
          wsResumen.addRow(["SUPERVISORAS ACTIVAS:", supervisorasActivas]);
          wsResumen.addRow(["CITAS REGISTRADAS HOY:", citasHoy]);
          wsResumen.addRow(["EFICIENCIA GENERAL DEL EQUIPO:", `${eficienciaGeneral}%`]);
          wsResumen.addRow(["FECHA DEL REPORTE:", document.getElementById('filtroFecha').value]);
          
          const wsEstadisticas = workbook.addWorksheet("ESTAD√çSTICAS POR SUPERVISORA");
          
          const tituloEstRow = wsEstadisticas.addRow(["ESTAD√çSTICAS POR SUPERVISORA"]);
          tituloEstRow.font = { size: 16, bold: true };
          tituloEstRow.alignment = { horizontal: 'center' };
          wsEstadisticas.mergeCells('A1:F1');
          
          wsEstadisticas.addRow([]);
          
          const headersEst = ["SUPERVISORA", "TOTAL CITAS", "CITAS HOY", "EFICIENCIA", "PORCENTAJE", "ESTADO"];
          const headerEstRow = wsEstadisticas.addRow(headersEst);
          
          headerEstRow.eachCell((cell) => {
              cell.fill = {
                  type: 'pattern',
                  pattern: 'solid',
                  fgColor: { argb: 'FF1E40AF' }
              };
              cell.font = {
                  bold: true,
                  color: { argb: 'FFFFFFFF' }
              };
              cell.alignment = { horizontal: 'center' };
              cell.border = {
                  top: { style: 'thin' },
                  left: { style: 'thin' },
                  bottom: { style: 'thin' },
                  right: { style: 'thin' }
              };
          });
          
          const statsPorSupervisora = {};
          const hoyExport = new Date().toISOString().split('T')[0];
          
          listaSupervisoras.forEach(supervisora => {
              const citasSupervisora = registrosPremanifiesto.filter(reg => reg.supervisora === supervisora);
              const citasHoy = citasSupervisora.filter(reg => 
                reg.fechaRegistro && reg.fechaRegistro.toString().includes(hoyExport)
              ).length;
              
              // ‚úÖ CORREGIDO: Se pasa supervisora como primer par√°metro
              const eficiencia = calcularEficienciaSupervisora(supervisora, citasHoy);
              const porcentaje = totalCitas > 0 ? ((citasSupervisora.length / totalCitas) * 100).toFixed(2) : 0;
              const estado = citasSupervisora.length > 0 ? "ACTIVA" : "SIN CITAS";
              
              statsPorSupervisora[supervisora] = {
                  total: citasSupervisora.length,
                  hoy: citasHoy,
                  eficiencia: eficiencia !== 0 ? `${eficiencia}%` : '0%',
                  porcentaje: `${porcentaje}%`,
                  estado: estado
              };
          });
          
          Object.keys(statsPorSupervisora).forEach(supervisora => {
              const stats = statsPorSupervisora[supervisora];
              
              wsEstadisticas.addRow([
                  supervisora,
                  stats.total,
                  stats.hoy,
                  stats.eficiencia,
                  stats.porcentaje,
                  stats.estado
              ]);
          });
          
          wsEstadisticas.columns = [
              { width: 25 }, { width: 15 }, { width: 15 }, { width: 15 }, { width: 15 }, { width: 15 }
          ];
          
          const wsDetalle = workbook.addWorksheet("DETALLE DE CITAS");
          
          const tituloDetRow = wsDetalle.addRow(["DETALLE COMPLETO DE CITAS"]);
          tituloDetRow.font = { size: 16, bold: true };
          tituloDetRow.alignment = { horizontal: 'center' };
          wsDetalle.mergeCells('A1:Q1');
          
          wsDetalle.addRow([]);
          
          const headersDet = [
            'NUM CITAS', 'CLIENTE Y NOMBRE ACOMPA√ëANTE', 'NUM PERSONAS', 'ESTADO CIVIL', 'HORA', 
            'D√çA EVENTO', 'SALON', 'EDAD', 'INGRESOS', 'TARJETA', 'CALIF DE ORIGEN', 'GERENTE', 
            'OPERADOR', 'VENDEDOR', 'BASE DE DATOS', 'SUPERVISORA', 'TELEFONO'
          ];
          
          const headerDetRow = wsDetalle.addRow(headersDet);
          
          headerDetRow.eachCell((cell) => {
              cell.fill = {
                  type: 'pattern',
                  pattern: 'solid',
                  fgColor: { argb: 'FF10B981' }
              };
              cell.font = {
                  bold: true,
                  color: { argb: 'FFFFFFFF' }
              };
              cell.alignment = { horizontal: 'center' };
              cell.border = {
                  top: { style: 'thin' },
                  left: { style: 'thin' },
                  bottom: { style: 'thin' },
                  right: { style: 'thin' }
              };
          });
          
          registrosPremanifiesto.forEach(registro => {
              const row = wsDetalle.addRow([
                  registro.citaPorDia || registro.cita || '',
                  registro.nombre || '',
                  registro.numPersonas || '',
                  registro.estadoCivil || '',
                  registro.hora || '',
                  registro.diaEvento || '',
                  registro.hotel || '',
                  registro.edad || '',
                  registro.ingresos || '',
                  registro.tarjeta || '',
                  registro.calificacionOrigen || '',
                  registro.gerente || '',
                  registro.operador || '',
                  registro.vendedor || '',
                  registro.baseDatos || '',
                  registro.supervisora || '',
                  registro.telefono || ''
              ]);
              
              row.eachCell((cell) => {
                  cell.border = {
                      top: { style: 'thin' },
                      left: { style: 'thin' },
                      bottom: { style: 'thin' },
                      right: { style: 'thin' }
                  };
              });
          });
          
          wsDetalle.columns = [
              { width: 10 }, { width: 35 }, { width: 15 }, { width: 15 }, { width: 12 },
              { width: 15 }, { width: 25 }, { width: 10 }, { width: 15 }, { width: 22 }, 
              { width: 18 }, { width: 15 }, { width: 15 }, { width: 12 }, { width: 15 }, 
              { width: 15 }, { width: 18 }
          ];
          
          workbook.xlsx.writeBuffer().then(buffer => {
              const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
              const fecha = new Date().toISOString().split('T')[0];
              
              let nombreArchivo = `REPORTE_ESTADISTICAS_${fecha}`;
              
              if (filtroFecha && filtroSupervisora) {
                nombreArchivo = `CITAS_${filtroSupervisora.replace(/\s+/g, '_')}_${fecha}`;
              }
              
              saveAs(blob, `${nombreArchivo}.xlsx`);
              mostrarNotificacion("REPORTE DE ESTAD√çSTICAS DESCARGADO CORRECTAMENTE");
          });
          
        } catch (error) {
          console.error('ERROR AL GENERAR EL REPORTE DE ESTAD√çSTICAS:', error);
          mostrarNotificacion('OCURRI√ì UN ERROR AL GENERAR EL REPORTE', 'error');
        }
      }

      // INICIAR EL SISTEMA
      inicializarSistema();

    });
  </script>
</body>
</html>