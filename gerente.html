<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel del Gerente</title>
  <meta name="description" content="Panel de control gerencial para Travel Life Club">
  <meta name="theme-color" content="#38bdf8">
  <link rel="icon" type="image/x-icon" href="Imagenes/logo.png">
  <link rel="preconnect" href="https://cdnjs.cloudflare.com/ajax/libs">
  <link rel="dns-prefetch" href="https://www.gstatic.com">
  <link rel="preload" href="Imagenes/logo.png" as="image">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>

  <style>
    /* ... (Todos los estilos anteriores se mantienen igual) ... */

    /* NUEVOS ESTILOS PARA BOTONES DE ADMINISTRACIÓN */
    .admin-controls {
      background: linear-gradient(145deg, #1e293b, #0f172a);
      padding: 25px;
      border-radius: 15px;
      margin: 30px 0;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(239, 68, 68, 0.3);
      position: relative;
      overflow: hidden;
    }

    .admin-controls::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 5px;
      background: linear-gradient(90deg, #ef4444, #dc2626, #b91c1c);
    }

    .admin-controls h3 {
      color: #f1f5f9;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 1.5rem;
    }

    .admin-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      align-items: center;
    }

    .btn-admin {
      background: linear-gradient(145deg, #ef4444, #dc2626);
      color: #0f172a;
      border: none;
      padding: 14px 22px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 5px 12px rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      gap: 10px;
      position: relative;
      overflow: hidden;
    }

    .btn-admin:hover {
      background: linear-gradient(145deg, #dc2626, #b91c1c);
      transform: translateY(-3px);
      box-shadow: 0 8px 18px rgba(239, 68, 68, 0.4);
    }

    .btn-admin:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .btn-admin.warning {
      background: linear-gradient(145deg, #f59e0b, #d97706);
    }

    .btn-admin.warning:hover {
      background: linear-gradient(145deg, #d97706, #b45309);
    }

    .btn-admin.success {
      background: linear-gradient(145deg, #10b981, #059669);
    }

    .btn-admin.success:hover {
      background: linear-gradient(145deg, #059669, #047857);
    }

    /* Modal de confirmación para acciones administrativas */
    .modal-admin {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.8);
      animation: fadeIn 0.3s;
    }

    .modal-admin-contenido {
      background: linear-gradient(145deg, #1e293b, #0f172a);
      margin: 15% auto;
      padding: 25px;
      border-radius: 16px;
      width: 400px;
      box-shadow: 0 20px 50px rgba(239, 68, 68, 0.3);
      animation: slideDown 0.3s;
      border: 1px solid rgba(239, 68, 68, 0.3);
      position: relative;
      overflow: hidden;
    }

    .modal-admin-contenido::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #ef4444, #dc2626, #b91c1c);
    }

    .modal-admin-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid rgba(239, 68, 68, 0.2);
    }

    .modal-admin-header h3 {
      color: #ef4444;
      font-size: 1.3rem;
      margin: 0;
    }

    .admin-actions {
      display: flex;
      gap: 15px;
      justify-content: flex-end;
      margin-top: 20px;
    }

    /* Información de depuración */
    .debug-info {
      margin-top: 20px;
      padding: 20px;
      background: rgba(30, 41, 59, 0.8);
      border-radius: 12px;
      font-size: 0.9rem;
      display: none;
      border: 1px solid rgba(56, 189, 248, 0.2);
      color: #60a5fa;
    }

    .debug-info h4 {
      color: #38bdf8;
      margin-bottom: 15px;
      font-size: 1.1rem;
    }

    .debug-content {
      font-family: 'Courier New', monospace;
      background: rgba(15, 23, 42, 0.6);
      padding: 15px;
      border-radius: 8px;
      overflow-x: auto;
      font-size: 0.85rem;
    }

    /* ... (El resto de los estilos se mantienen igual) ... */
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo-container">
        <div class="logo-img-container">
          <img src="Imagenes/logo.png" alt="Logo Travel Life Club">
        </div>
        <div class="logo-text">
          <h1>Travel Life Club</h1>
          <p>Panel de Control - Gerente</p>
        </div>
      </div>
      <div class="header-controls">
        <button class="btn-filtro" id="actualizarBtn">
          <i class="fas fa-sync-alt"></i> Actualizar
        </button>
        <button class="btn-filtro btn-exportar" id="exportarExcel">
          <i class="fas fa-file-excel"></i> Exportar Excel
        </button>
        <button class="btn-filtro btn-volver" onclick="window.location.href='index.html'">
          <i class="fas fa-arrow-left"></i> Volver al Sistema
        </button>
      </div>
    </header>

    <!-- Resumen General -->
    <section class="resumen-general" id="resumenGeneral">
      <!-- Los datos del resumen se generarán dinámicamente -->
    </section>

    <!-- NUEVA SECCIÓN: Controles de Administración -->
    <section class="admin-controls">
      <h3><i class="fas fa-cogs"></i> Controles de Administración</h3>
      <div class="admin-buttons">
        <button class="btn-admin warning" id="limpiarRegistros">
          <i class="fas fa-trash-alt"></i> Limpiar Todos los Registros
        </button>
        <button class="btn-admin success" id="descargarEliminados">
          <i class="fas fa-file-export"></i> Descargar Registros Eliminados
        </button>
        <button class="btn-admin" id="debugBtn">
          <i class="fas fa-bug"></i> Depuración del Sistema
        </button>
      </div>
    </section>

    <!-- Gráfico de distribución -->
    <div class="grafico-container">
      <h2><i class="fas fa-chart-bar"></i> Distribución de Citas por Supervisora</h2>
      <div id="graficoBarras">
        <!-- Gráfico se generará dinámicamente -->
      </div>
    </div>

    <!-- Sección de Estadísticas por Supervisora -->
    <section class="estadisticas-supervisoras">
      <h2><i class="fas fa-chart-pie"></i> Estadísticas por Supervisora</h2>
      <div class="estadisticas-grid" id="estadisticasGrid">
        <!-- Las estadísticas se generarán dinámicamente aquí -->
      </div>
    </section>

    <!-- Panel del Gerente -->
    <section class="gerente-panel">
      <h2><i class="fas fa-chart-line"></i> Estadísticas por Supervisora</h2>
      
      <!-- Controles para el panel del gerente -->
      <div class="panel-controls">
        <div class="filtro-group">
          <label for="filtroFecha"><i class="fas fa-calendar-alt"></i> Filtrar por fecha:</label>
          <input type="date" id="filtroFecha">
        </div>
        
        <div class="filtro-group">
          <label for="filtroSupervisora"><i class="fas fa-user-tie"></i> Filtrar por supervisora:</label>
          <select id="filtroSupervisora">
            <option value="">Todas las supervisoras</option>
            <option>LUIS COLULA</option>
            <option>MACARENA ZAMORA</option>
            <option>THALIA PINEDA</option>
            <option>YARET NAJERA</option>
          </select>
        </div>
        
        <div class="btn-group">
          <button type="button" id="aplicarFiltro" class="btn-filtro">
            <i class="fas fa-filter"></i> Aplicar Filtros
          </button>
          <button type="button" id="limpiarFiltro" class="btn-filtro btn-limpiar">
            <i class="fas fa-broom"></i> Limpiar
          </button>
        </div>
      </div>
      
      <div class="stats-container" id="statsContainer">
        <!-- Las estadísticas se generarán dinámicamente aquí -->
      </div>
      
      <div class="supervisora-detalle" id="supervisoraDetalle">
        <!-- Los detalles de cada supervisora se generarán aquí -->
      </div>
    </section>

    <!-- Información de depuración -->
    <div class="debug-info" id="debugInfo">
      <h4>Información de Depuración del Sistema</h4>
      <div class="debug-content" id="debugContent"></div>
    </div>
  </div>

  <!-- Modal de confirmación para limpiar registros -->
  <div id="modalConfirmacion" class="modal-admin">
    <div class="modal-admin-contenido">
      <div class="modal-admin-header">
        <h3><i class="fas fa-exclamation-triangle"></i> Confirmar Acción</h3>
        <span class="cerrar-modal">&times;</span>
      </div>
      <p id="mensajeConfirmacion">¿Está seguro de que desea realizar esta acción? Esta acción no se puede deshacer.</p>
      <div class="admin-actions">
        <button class="btn-admin" id="cancelarAccion">Cancelar</button>
        <button class="btn-admin warning" id="confirmarAccion">Confirmar</button>
      </div>
    </div>
  </div>

  <!-- Librerías necesarias -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- ExcelJS para estilos en Excel -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
  <!-- FileSaver para guardar archivos -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <script>
    // Configuración de Firebase - DEBE SER LA MISMA QUE EN TU SISTEMA PRINCIPAL
    const firebaseConfig = {
      apiKey: "AIzaSyASUJrQNMW80DDMV8gFzjTYPUd8x3B5YDk",
      authDomain: "invitacionpremanfiesto.firebaseapp.com",
      databaseURL: "https://invitacionpremanfiesto-default-rtdb.firebaseio.com",
      projectId: "invitacionpremanfiesto",
      storageBucket: "invitacionpremanfiesto.firebasestorage.app",
      messagingSenderId: "362764197269",
      appId: "1:362764197269:web:058b028dcc53d299df6a9c",
      measurementId: "G-JYTW87S1MP"
    };

    // Inicializar Firebase
    firebase.initializeApp(firebaseConfig);

    // Variables para el historial de eliminados
    let historialEliminados = JSON.parse(localStorage.getItem('historial_eliminados') || '[]');

    document.addEventListener("DOMContentLoaded", function () {
      let registrosPremanifiesto = [];
      let actualizando = false;
      let accionPendiente = null;
      
      // Elementos del modal de confirmación
      const modalConfirmacion = document.getElementById('modalConfirmacion');
      const mensajeConfirmacion = document.getElementById('mensajeConfirmacion');
      const btnCancelarAccion = document.getElementById('cancelarAccion');
      const btnConfirmarAccion = document.getElementById('confirmarAccion');
      const btnCerrarModal = document.querySelector('.cerrar-modal');

      // CONFIGURAR FIREBASE REALTIME DATABASE
      function configurarFirebase() {
          const database = firebase.database();
          const registrosRef = database.ref('registrosPremanifiesto');
          
          console.log("Conectando a Firebase desde el Panel del Gerente...");
          
          // Escuchar cambios en tiempo real desde Firebase
          registrosRef.on('value', (snapshot) => {
              const data = snapshot.val();
              if (data) {
                  // Convertir objeto de Firebase a array
                  registrosPremanifiesto = Object.values(data);
                  console.log("Datos sincronizados desde Firebase:", registrosPremanifiesto.length);
                  
                  // Actualizar el panel del gerente
                  actualizarPanelGerente();
                  
                  mostrarNotificacion("Datos actualizados en tiempo real desde Firebase");
              } else {
                  console.log("No hay datos en Firebase");
                  registrosPremanifiesto = [];
                  actualizarPanelGerente();
              }
          });
      }

      function mostrarNotificacion(mensaje, tipo = 'success') {
        // Crear elemento de notificación
        const notificacion = document.createElement('div');
        notificacion.innerHTML = `<i class="fas fa-${tipo === 'error' ? 'exclamation-triangle' : 'info-circle'}"></i> ${mensaje}`;
        notificacion.className = `notificacion ${tipo === 'error' ? 'error' : ''}`;
        
        document.body.appendChild(notificacion);
        
        // Eliminar después de 4 segundos
        setTimeout(() => {
          if (notificacion.parentNode) {
            document.body.removeChild(notificacion);
          }
        }, 4000);
      }

      // --- FUNCIÓN PARA MOSTRAR MODAL DE CONFIRMACIÓN ---
      function mostrarConfirmacion(mensaje, accion) {
        mensajeConfirmacion.textContent = mensaje;
        accionPendiente = accion;
        modalConfirmacion.style.display = 'block';
      }

      // --- LIMPIAR TODOS LOS REGISTROS ---
      function limpiarTodosLosRegistros() {
        // Guardar copia de seguridad antes de eliminar
        const backup = {
          fecha: new Date().toISOString(),
          registros: [...registrosPremanifiesto],
          total: registrosPremanifiesto.length
        };
        
        // Agregar al historial de eliminados
        historialEliminados.push(backup);
        localStorage.setItem('historial_eliminados', JSON.stringify(historialEliminados));
        
        // Limpiar registros
        registrosPremanifiesto = [];
        
        // Guardar cambios en Firebase
        const database = firebase.database();
        database.ref('registrosPremanifiesto').set({})
          .then(() => {
            console.log("Todos los registros han sido eliminados de Firebase");
            actualizarPanelGerente();
            mostrarNotificacion(`Se eliminaron ${backup.total} registros correctamente. Se creó una copia de seguridad.`);
          })
          .catch(error => {
            console.error("Error al eliminar registros de Firebase:", error);
            mostrarNotificacion("Error al eliminar registros", 'error');
          });
      }

      // --- DESCARGAR REGISTROS ELIMINADOS ---
      function descargarRegistrosEliminados() {
        if (historialEliminados.length === 0) {
          mostrarNotificacion("No hay registros eliminados para descargar", 'error');
          return;
        }

        try {
          // Crear un nuevo libro de Excel
          const workbook = new ExcelJS.Workbook();
          
          // Para cada elemento del historial, crear una hoja
          historialEliminados.forEach((backup, index) => {
            const worksheet = workbook.addWorksheet(`Eliminados_${index + 1}`);
            
            // Título
            const fecha = new Date(backup.fecha);
            const titulo = `REGISTROS ELIMINADOS - ${fecha.toLocaleDateString('es-MX')} ${fecha.toLocaleTimeString('es-MX')}`;
            
            const tituloRow = worksheet.addRow([titulo]);
            tituloRow.font = { size: 16, bold: true };
            tituloRow.alignment = { horizontal: 'center' };
            worksheet.mergeCells('A1:P1');
            
            // Saltar una línea
            worksheet.addRow([]);
            
            // Información del backup
            const infoRow = worksheet.addRow([`Total de registros eliminados: ${backup.total}`]);
            infoRow.font = { bold: true };
            worksheet.mergeCells('A3:P3');
            
            worksheet.addRow([]);
            
            // Encabezados
            const headers = [
              'NUM CITAS', 'CLIENTE Y NOMBREACOMPAÑANTE', 'NUM PERSONAS', 'ESTADO CIVIL', 'HORA', 
              'DÍA EVENTO', 'SALON', 'EDAD', 'TARJETA', 'CALIF DE ORIGEN', 'GERENTE', 
              'OPERADOR', 'VENDEDOR', 'BASE DE DATOS', 'SUPERVISORA', 'TELEFONO'
            ];
            
            const headerRow = worksheet.addRow(headers);
            
            // Aplicar estilo a los encabezados
            headerRow.eachCell((cell) => {
                cell.fill = {
                    type: 'pattern',
                    pattern: 'solid',
                    fgColor: { argb: 'FFE74C3C' }
                };
                cell.font = {
                    bold: true,
                    color: { argb: 'FFFFFFFF' }
                };
                cell.alignment = { horizontal: 'center' };
                cell.border = {
                    top: { style: 'thin' },
                    left: { style: 'thin' },
                    bottom: { style: 'thin' },
                    right: { style: 'thin' }
                };
            });
            
            // Añadir datos
            backup.registros.forEach(registro => {
                const row = worksheet.addRow([
                    registro.citaPorDia || registro.cita,
                    registro.nombre,
                    registro.numPersonas,
                    registro.estadoCivil,
                    registro.hora,
                    registro.diaEvento || '',
                    registro.hotel,
                    registro.edad,
                    registro.tarjeta,
                    registro.calificacionOrigen,
                    registro.gerente,
                    registro.operador,
                    registro.vendedor,
                    registro.baseDatos,
                    registro.supervisora,
                    registro.telefono
                ]);
                
                // Aplicar bordes a todas las celdas
                row.eachCell((cell) => {
                    cell.border = {
                        top: { style: 'thin' },
                        left: { style: 'thin' },
                        bottom: { style: 'thin' },
                        right: { style: 'thin' }
                    };
                });
            });
            
            // Ajustar anchos de columnas
            worksheet.columns = [
                { width: 10 }, { width: 35 }, { width: 15 }, { width: 15 }, { width: 12 },
                { width: 15 }, { width: 25 }, { width: 10 }, { width: 22 }, { width: 18 },
                { width: 15 }, { width: 15 }, { width: 12 }, { width: 15 }, { width: 15 }, { width: 18 }
            ];
          });
          
          // Generar el archivo Excel
          workbook.xlsx.writeBuffer().then(buffer => {
              const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
              const fecha = new Date().toISOString().split('T')[0];
              saveAs(blob, `Registros_Eliminados_Completos_${fecha}.xlsx`);
              mostrarNotificacion("Archivo de registros eliminados descargado correctamente");
          });
          
        } catch (error) {
          console.error('Error al generar el Excel de eliminados:', error);
          mostrarNotificacion('Ocurrió un error al generar el archivo', 'error');
        }
      }

      // --- MOSTRAR INFORMACIÓN DE DEPURACIÓN ---
      function mostrarInformacionDepuracion() {
        const debugInfo = document.getElementById("debugInfo");
        const debugContent = document.getElementById("debugContent");
        
        if (debugInfo.style.display === "block") {
          debugInfo.style.display = "none";
          document.getElementById("debugBtn").innerHTML = '<i class="fas fa-bug"></i> Depuración del Sistema';
        } else {
          debugInfo.style.display = "block";
          document.getElementById("debugBtn").innerHTML = '<i class="fas fa-times"></i> Ocultar Depuración';
          
          // Mostrar información de depuración
          const info = {
            'Registros actuales': registrosPremanifiesto.length,
            'Historial de eliminados': historialEliminados.length,
            'Total eliminados': historialEliminados.reduce((total, backup) => total + backup.total, 0),
            'Firebase conectado': firebase.app().name ? "Sí" : "No",
            'Última sincronización': new Date().toLocaleString(),
            'Navegador': navigator.userAgent,
            'Estado de conexión': navigator.onLine ? "En línea" : "Sin conexión",
            'Memoria usada': Math.round(performance.memory.usedJSHeapSize / 1048576) + ' MB'
          };
          
          let contenido = '';
          Object.keys(info).forEach(key => {
            contenido += `<div><strong>${key}:</strong> ${info[key]}</div>`;
          });
          
          // Agregar información del historial de eliminados
          contenido += '\n\n<strong>Historial detallado:</strong>\n';
          historialEliminados.forEach((backup, index) => {
            const fecha = new Date(backup.fecha);
            contenido += `\n${index + 1}. ${fecha.toLocaleString()} - ${backup.total} registros`;
          });
          
          debugContent.innerHTML = contenido;
        }
      }

      // --- EVENT LISTENERS PARA BOTONES DE ADMINISTRACIÓN ---
      
      // Limpiar todos los registros
      document.getElementById("limpiarRegistros").addEventListener("click", function() {
        if (registrosPremanifiesto.length === 0) {
          mostrarNotificacion("No hay registros para eliminar", 'error');
          return;
        }
        
        mostrarConfirmacion(
          `¿Está seguro de que desea eliminar TODOS los ${registrosPremanifiesto.length} registros? Esta acción es irreversible pero se creará una copia de seguridad.`,
          'limpiar'
        );
      });
      
      // Descargar registros eliminados
      document.getElementById("descargarEliminados").addEventListener("click", function() {
        descargarRegistrosEliminados();
      });
      
      // Botón de depuración
      document.getElementById("debugBtn").addEventListener("click", function() {
        mostrarInformacionDepuracion();
      });
      
      // Confirmar acción en modal
      btnConfirmarAccion.addEventListener("click", function() {
        if (accionPendiente === 'limpiar') {
          limpiarTodosLosRegistros();
        }
        modalConfirmacion.style.display = 'none';
        accionPendiente = null;
      });
      
      // Cancelar acción en modal
      btnCancelarAccion.addEventListener("click", function() {
        modalConfirmacion.style.display = 'none';
        accionPendiente = null;
      });
      
      // Cerrar modal
      btnCerrarModal.addEventListener("click", function() {
        modalConfirmacion.style.display = 'none';
        accionPendiente = null;
      });
      
      // Cerrar modal al hacer clic fuera
      window.addEventListener('click', function(event) {
        if (event.target === modalConfirmacion) {
          modalConfirmacion.style.display = 'none';
          accionPendiente = null;
        }
      });

      // ... (El resto del código del panel del gerente se mantiene igual) ...
      
      // INICIALIZAR FIREBASE Y EL PANEL
      configurarFirebase();
      
      // Establecer la fecha actual como valor por defecto en el filtro
      const hoy = new Date().toISOString().split('T')[0];
      document.getElementById('filtroFecha').value = hoy;
    });
  </script>
</body>
</html>